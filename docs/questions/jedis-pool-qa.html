<!DOCTYPE html> <html lang="en" dir="auto"> <head><meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5, user-scalable=no"> <meta name="description" content="Timeout waiting for idle object 以下内容为笔者实践而来，并结合自己的推测整理。若有不对或疏漏的欢迎交流。 问题引出 现象：某次高并发过后，应用系统部分接口仍旧出现系统异常。查看应用日志，初步推断为redis连接池问题，查看grafana中的redis监控，red..."> <meta name="revised" content="3e759db77de0ee3cdf2a53b3411433f3c7f9a7e9"> <meta name="author" content="Reworld"> <meta name="generator" content="jekyll-rtd-theme v2.0.10"><meta name="theme-color" content="#2980b9"> <title>无法从Redis池中获取连接 · Youzhanghao's Blog</title> <meta name="twitter:title" content="无法从Redis池中获取连接 · Youzhanghao's Blog"> <meta name="twitter:description" content="Timeout waiting for idle object 以下内容为笔者实践而来，并结合自己的推测整理。若有不对或疏漏的欢迎交流。 问题引出 现象：某次高并发过后，应用系统部分接口仍旧出现系统异常。查看应用日志，初步推断为redis连接池问题，查看grafana中的redis监控，red..."> <meta name="twitter:card" content="summary"> <meta name="twitter:site" content="@Reworld"> <meta name="twitter:url" content="/questions/jedis-pool-qa.html"> <meta name="twitter:creator" content="@jekyll-rtd-theme v2.0.10"> <meta property="og:title" content="无法从Redis池中获取连接 · Youzhanghao's Blog"> <meta property="og:description" content="Timeout waiting for idle object 以下内容为笔者实践而来，并结合自己的推测整理。若有不对或疏漏的欢迎交流。 问题引出 现象：某次高并发过后，应用系统部分接口仍旧出现系统异常。查看应用日志，初步推断为redis连接池问题，查看grafana中的redis监控，red..."> <meta property="og:locale" content="en"> <meta property="og:url" content="/questions/jedis-pool-qa.html"> <meta property="og:type" content="article"> <meta property="article:author" content="Reworld"> <meta property="article:published_time" content="2016-12-19T14:18:56+08:00"> <meta property="article:modified_time" content="2023-01-06T15:59:11+08:00"> <script type="application/ld+json"> { "@context": "https://schema.org", "@type": "Article", "mainEntityOfPage": { "@type": "WebPage", "@id": "/questions/jedis-pool-qa.html" }, "headline": "无法从Redis池中获取连接 · Youzhanghao's Blog", "image": [], "author": { "@type": "Person", "name": "Reworld" }, "datePublished": "2016-12-19T14:18:56+08:00", "dateModified": "2023-01-06T15:59:11+08:00", "publisher": { "@type": "User", "name": "Reworld", "logo": { "@type": "ImageObject", "url": "https://avatars.githubusercontent.com/u/24401230?v=4" } }, "description": "Timeout waiting for idle object 以下内容为笔者实践而来，并结合自己的推测整理。若有不对或疏漏的欢迎交流。 问题引出 现象：某次高并发过后，应用系统部分接口仍旧出现系统异常。查看应用日志，初步推断为redis连接池问题，查看grafana中的redis监控，red..." } </script> <link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="canonical" href="/questions/jedis-pool-qa.html"><link rel="icon" type="image/svg+xml" href="/assets/images/favicon.svg"><link rel="icon" type="image/png" href="/assets/images/favicon-16x16.png" sizes="16x16"> <link rel="icon" type="image/png" href="/assets/images/favicon-32x32.png" sizes="32x32"> <link rel="icon" type="image/png" href="/assets/images/favicon-96x96.png" sizes="96x96"><link rel="mask-icon" href="/assets/images/favicon.svg" color="#2980b9"><link rel="apple-touch-icon" href="/assets/images/apple-touch-icon-300x300.jpg"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/rundocs/jekyll-rtd-theme@2.0.10/assets/css/theme.min.css"><script> window.ui = { title: "Youzhanghao's Blog", baseurl: "", i18n: { search_results: "Search Results", search_results_found: "Search finished, found # page(s) matching the search query.", search_results_not_found: "Your search did not match any documents, please make sure that all characters are spelled correctly!" } }; </script> </head> <body class="container"><div class="sidebar-wrap overflow-hidden"> <div class="sidebar height-full overflow-y-scroll overflow-x-hidden"> <div class="header d-flex flex-column p-3 text-center"> <div class="title pb-1"> <a class="h4 no-underline py-1 px-2 rounded-1" href="/" title="Record Something"> <i class="fa fa-home"></i> Youzhanghao's Blog </a> </div> <span class="version"></span> <form class="search pt-2" action="/search.html" method="get" autocomplete="off"> <input class="form-control input-block input-sm" type="text" name="q" placeholder="Search docs..."> </form> </div> <div class="toctree py-2" data-spy="affix" role="navigation" aria-label="main navigation"> <ul> </ul> <a class="caption d-block text-uppercase no-wrap px-2 py-0" href="/database/"> 数据库 </a><ul> <li class="toc level-1 " data-sort="" data-level="1"> <a class="d-flex flex-items-baseline " href="/database/kingbase.html">人大金仓kingbase</a> </li> <li class="toc level-1 " data-sort="" data-level="1"> <a class="d-flex flex-items-baseline " href="/database/mysql.html">MySQL</a> </li> <li class="toc level-1 " data-sort="" data-level="1"> <a class="d-flex flex-items-baseline " href="/database/pgsql.html">PgSQL</a> </li>
</ul> <a class="caption d-block text-uppercase no-wrap px-2 py-0" href="/java/"> Java </a><ul> <li class="toc level-1 " data-sort="" data-level="1"> <a class="d-flex flex-items-baseline " href="/java/Jenkins.html">Jenkins</a> </li> <li class="toc level-1 " data-sort="" data-level="1"> <a class="d-flex flex-items-baseline " href="/java/cacheAsspectSupport-read.html">@Cacheable源码解读</a> </li> <li class="toc level-1 " data-sort="" data-level="1"> <a class="d-flex flex-items-baseline " href="/java/jedis-pool.html">低版本中Jedis对象泄漏证明及探究</a> </li> <li class="toc level-1 " data-sort="" data-level="1"> <a class="d-flex flex-items-baseline " href="/java/maven.html">Maven</a> </li> <li class="toc level-1 " data-sort="" data-level="1"> <a class="d-flex flex-items-baseline " href="/java/redis-config.html">redis配置解读</a> </li>
</ul> <a class="caption d-block text-uppercase no-wrap px-2 py-0" href="/python/"> Python </a><ul> <li class="toc level-1 " data-sort="1" data-level="1"> <a class="d-flex flex-items-baseline " href="/python/2018-06-05-python%E8%AF%AD%E6%B3%95-1.html">1. 变量与基本类型</a> </li> <li class="toc level-1 " data-sort="2" data-level="1"> <a class="d-flex flex-items-baseline " href="/python/2018-06-07-python%E8%AF%AD%E6%B3%95-2.html">2. 数字</a> </li> <li class="toc level-1 " data-sort="3" data-level="1"> <a class="d-flex flex-items-baseline " href="/python/2018-06-10-python%E8%AF%AD%E6%B3%95-3.html">3. 序列字符串</a> </li>
</ul> <a class="caption d-block text-uppercase no-wrap px-2 py-0" href="/questions/"> 问题集 </a><ul> <li class="toc level-1 current" data-sort="" data-level="1"> <a class="d-flex flex-items-baseline current" href="/questions/jedis-pool-qa.html">无法从Redis池中获取连接</a> </li>
</ul> <a class="caption d-block text-uppercase no-wrap px-2 py-0" href="/tool/"> 工具 </a><ul> <li class="toc level-1 " data-sort="" data-level="1"> <a class="d-flex flex-items-baseline " href="/tool/redis-stat.html">redis-stat</a> </li> <li class="toc level-1 " data-sort="" data-level="1"> <a class="d-flex flex-items-baseline " href="/tool/ab.html">ab</a> </li> <li class="toc level-1 " data-sort="" data-level="1"> <a class="d-flex flex-items-baseline " href="/tool/idea-jar-debug.html">Idea中引入源码包调试</a> </li> <li class="toc level-1 " data-sort="" data-level="1"> <a class="d-flex flex-items-baseline " href="/tool/idea-plugin.html">Idea常用插件及安装</a> </li> <li class="toc level-1 " data-sort="" data-level="1"> <a class="d-flex flex-items-baseline " href="/tool/idea-remote-debug.html">Idea远程调试</a> </li> <li class="toc level-1 " data-sort="" data-level="1"> <a class="d-flex flex-items-baseline " href="/tool/jekyll.html">Jekyll</a> </li> <li class="toc level-1 " data-sort="" data-level="1"> <a class="d-flex flex-items-baseline " href="/tool/maven-dependency.html">maven依赖管理</a> </li>
</ul> <a class="caption d-block text-uppercase no-wrap px-2 py-0" href="/others/"> 其他 </a><ul> <li class="toc level-1 " data-sort="" data-level="1"> <a class="d-flex flex-items-baseline " href="/others/2018-06-03-markdown.html">Markdown</a> </li> <li class="toc level-1 " data-sort="" data-level="1"> <a class="d-flex flex-items-baseline " href="/others/github-push.html">Github Pages</a> </li> <li class="toc level-1 " data-sort="" data-level="1"> <a class="d-flex flex-items-baseline " href="/others/jekyll-install.html">Jekyll安装</a> </li>
</ul> </div> </div> </div> <div class="content-wrap"> <div class="header d-flex flex-justify-between p-2 hide-lg hide-xl" aria-label="top navigation"> <button id="toggle" aria-label="Toggle menu" class="btn-octicon p-2 m-0 text-white" type="button"> <i class="fa fa-bars"></i> </button> <div class="title flex-1 d-flex flex-justify-center"> <a class="h4 no-underline py-1 px-2 rounded-1" href="/">Youzhanghao's Blog</a> </div> </div> <div class="content p-3 p-sm-5"> <div class="navigation-top d-flex flex-justify-between"> <ul class="breadcrumb" role="navigation" aria-label="breadcrumbs navigation"> <li class="breadcrumb-item"> <a class="no-underline" href="/" title="/"> <i class="fa fa-home"></i> </a> </li>
<li class="breadcrumb-item"><a href="/questions/">questions</a></li>
<li class="breadcrumb-item" aria-current="page">jedis-pool-qa.md</li>
</ul> <a class="edit" href="https://github.com/youzhanghao/youzhanghao.github.io/edit/gh-pages/questions/jedis-pool-qa.md" title="Edit on GitHub" rel="noreferrer" target="_blank"> <i class="fa fa-edit"></i> </a> </div> <hr> <p><em>发布时间：2016-12-19 14:18:56</em> <em style="float:right">更新时间：2022-12-21 18:10:31</em></p> <div role="main" itemscope="itemscope" itemtype="https://schema.org/Article"> <div class="markdown-body" itemprop="articleBody"> <h1 id="timeout-waiting-for-idle-object">Timeout waiting for idle object</h1> <blockquote> <p>以下内容为笔者实践而来，并结合自己的推测整理。若有不对或疏漏的欢迎交流。</p> </blockquote> <h2 id="问题引出">问题引出</h2> <blockquote> <p>现象：某次高并发过后，应用系统部分接口仍旧出现系统异常。查看应用日志，初步推断为redis连接池问题，查看grafana中的redis监控，redis客户端连接数较少</p> </blockquote> <p><img src="https://img-blog.csdnimg.cn/c427ca0068cc4e62bd64276104e8b8a0.png#pic_left" alt="在这里插入图片描述"></p> <p>临时快速解决方法：<strong><font color="red">重启应用</font></strong></p> <p>Ps: 重启大法好 –，–！</p> <h2 id="问题初探">问题初探</h2> <h3 id="初步排查">初步排查</h3> <ol> <li> <p>拉取生产应用日志</p> <p><img src="https://img-blog.csdnimg.cn/4f1e5fe6f34944cb88e396bc5efb6c55.png#pic_left" alt="在这里插入图片描述"></p> <p><img src="https://img-blog.csdnimg.cn/acba83df83ca433ba73b38be14a44add.png#pic_left" alt="在这里插入图片描述"></p> </li> <li> <p>根据日志，初步推测为redis连接池问题导致问题发生，查看生产Redis监控，发现Redis在高并发时间段，连接数较多，但对于redis服务端来说，仍在可控范围，并且在高峰过后，Redis连接已被释放。于是引出两个问题需要弄清</p> <blockquote> <ol> <li>高峰时间段Redis服务端无问题，难道是Java应用的连接池满了？</li> <li>Redis连接释放后，为何还是无法从连接池中获取到对象？</li> </ol> </blockquote> </li> </ol> <h3 id="问题复现">问题复现</h3> <p>使用ab作为模拟高并发工具。参考<a href="/tool/ab.html">ab简介与基本使用</a></p> <p>使用redis-stat实时监控redis服务端信息。参考<a href="../tool/redis-stat">redis-stat简介与基本使用</a></p> <p>应用debug，若应用部署在服务器，采用remote-debug形式。参考<a href="../tool/idea-remote-debug">Idea远程调试</a></p> <p>步骤</p> <ol> <li> <p>ab脚本50并发压测服务器，观察redis服务器情况(连接数)；服务器连接数达到应用Jedis-pool的配置的连接数；整体表现和生产相同；（由于仅限复现问题，适当调小Jedis配置）</p> <div class="language-yaml highlighter-rouge notranslate">
<div class="highlight">
<pre class="highlight"><code>   <span class="s">spring</span>
   <span class="s">redis</span><span class="pi">:</span>
      <span class="c1"># 地址</span>
      <span class="na">host</span><span class="pi">:</span> <span class="s">localhost</span>
      <span class="c1"># 端口，默认为6379</span>
      <span class="na">port</span><span class="pi">:</span> <span class="m">26379</span>
      <span class="na">password</span><span class="pi">:</span> <span class="s">3edcVFR$</span>
      <span class="c1"># 连接超时时间</span>
      <span class="na">timeout</span><span class="pi">:</span> <span class="s">10s</span>
      <span class="na">jedis</span><span class="pi">:</span>
          <span class="na">pool</span><span class="pi">:</span>
              <span class="c1"># 连接池中的最小空闲连接</span>
              <span class="na">min-idle</span><span class="pi">:</span> <span class="m">2</span>
              <span class="c1"># 连接池中的最大空闲连接</span>
              <span class="na">max-idle</span><span class="pi">:</span> <span class="m">6</span>
              <span class="c1"># 连接池的最大数据库连接数</span>
              <span class="na">max-active</span><span class="pi">:</span> <span class="m">6</span>
              <span class="c1"># 连接池最大阻塞等待时间（使用负值表示没有限制）300ms</span>
              <span class="na">max-wait</span><span class="pi">:</span> <span class="m">300</span>
</code></pre>  </div> </div> </li> <li>观察Redis服务端情况，表现和生产相同 <img src="https://img-blog.csdnimg.cn/990602aca60d4e99ae3db6a1efb22f53.png#pic_left" alt="在这里插入图片描述">
</li> <li>请求相关接口，都已经表现为系统异常，并且redis服务端连接释放后，系统仍未恢复；和生产表现相同，至此，生产问题完全复现 <img src="https://img-blog.csdnimg.cn/92ec44926473496e86b299b524d2b2a0.png#pic_left" alt="在这里插入图片描述">
</li> </ol> <h3 id="源码排查">源码排查</h3> <p>高并发接口中的代码，引用了<a href="https://github.com/Cacheable" class="user-mention">@Cacheable</a>(该注解请参考<a href="../java/cacheAsspectSupport-read">@Cache部分源码解读</a>)</p> <p><em>时序图参考</em></p> <p><img src="https://img-blog.csdnimg.cn/f92527d669cc4b659566d5f736ff19e0.jpeg#pic_center" alt="在这里插入图片描述"></p> <div class="language-java highlighter-rouge notranslate"><div class="highlight">
<pre class="highlight"><code>  <span class="nd">@Cacheable</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">"history"</span><span class="o">)</span>
  <span class="kd">public</span> <span class="nc">Integer</span> <span class="nf">canDutyPersonNum</span><span class="o">(</span><span class="nc">String</span> <span class="n">orgCode</span><span class="o">,</span> <span class="nc">Integer</span> <span class="n">jgsx</span><span class="o">)</span> <span class="o">{</span>
  <span class="c1">// 省略</span>
  <span class="o">}</span>
</code></pre>  </div></div> <p><a href="https://github.com/Cacheable" class="user-mention">@Cacheable</a>主要是通过CacheAspectSupport实现，处理流程大致为excute()-&gt;excute()-&gt;findCachedItem()-&gt;findInCaches()-&gt;Cache.ValueWrapper.doGet()</p> <div class="language-java highlighter-rouge notranslate"><div class="highlight">
<pre class="highlight"><code>    <span class="nc">CacheAspectSupport</span><span class="o">.</span><span class="na">java</span>	
      
   	<span class="nd">@Nullable</span>
  	<span class="kd">protected</span> <span class="nc">Object</span> <span class="nf">execute</span><span class="o">(</span><span class="nc">CacheOperationInvoker</span> <span class="n">invoker</span><span class="o">,</span> <span class="nc">Object</span> <span class="n">target</span><span class="o">,</span> <span class="nc">Method</span> <span class="n">method</span><span class="o">,</span> <span class="nc">Object</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
  		<span class="c1">// Check whether aspect is enabled (to cope with cases where the AJ is pulled in automatically)</span>
  		<span class="k">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">initialized</span><span class="o">)</span> <span class="o">{</span>
  			<span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">targetClass</span> <span class="o">=</span> <span class="n">getTargetClass</span><span class="o">(</span><span class="n">target</span><span class="o">);</span>
  			<span class="nc">CacheOperationSource</span> <span class="n">cacheOperationSource</span> <span class="o">=</span> <span class="n">getCacheOperationSource</span><span class="o">();</span>
  			<span class="k">if</span> <span class="o">(</span><span class="n">cacheOperationSource</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
  				<span class="nc">Collection</span><span class="o">&lt;</span><span class="nc">CacheOperation</span><span class="o">&gt;</span> <span class="n">operations</span> <span class="o">=</span> <span class="n">cacheOperationSource</span><span class="o">.</span><span class="na">getCacheOperations</span><span class="o">(</span><span class="n">method</span><span class="o">,</span> <span class="n">targetClass</span><span class="o">);</span>
  				<span class="k">if</span> <span class="o">(!</span><span class="nc">CollectionUtils</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">(</span><span class="n">operations</span><span class="o">))</span> <span class="o">{</span>
  					<span class="k">return</span> <span class="nf">execute</span><span class="o">(</span><span class="n">invoker</span><span class="o">,</span> <span class="n">method</span><span class="o">,</span>
  							<span class="k">new</span> <span class="nf">CacheOperationContexts</span><span class="o">(</span><span class="n">operations</span><span class="o">,</span> <span class="n">method</span><span class="o">,</span> <span class="n">args</span><span class="o">,</span> <span class="n">target</span><span class="o">,</span> <span class="n">targetClass</span><span class="o">));</span>
  				<span class="o">}</span>
  			<span class="o">}</span>
  		<span class="o">}</span>
  
  		<span class="k">return</span> <span class="n">invoker</span><span class="o">.</span><span class="na">invoke</span><span class="o">();</span>
  	<span class="o">}</span>
  
  <span class="c1">// ...</span>
  
  <span class="nd">@Nullable</span>
  	<span class="kd">private</span> <span class="nc">Object</span> <span class="nf">execute</span><span class="o">(</span><span class="kd">final</span> <span class="nc">CacheOperationInvoker</span> <span class="n">invoker</span><span class="o">,</span> <span class="nc">Method</span> <span class="n">method</span><span class="o">,</span> <span class="nc">CacheOperationContexts</span> <span class="n">contexts</span><span class="o">)</span> <span class="o">{</span>
  		<span class="c1">// Special handling of synchronized invocation</span>
  		<span class="k">if</span> <span class="o">(</span><span class="n">contexts</span><span class="o">.</span><span class="na">isSynchronized</span><span class="o">())</span> <span class="o">{</span>
  			<span class="nc">CacheOperationContext</span> <span class="n">context</span> <span class="o">=</span> <span class="n">contexts</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="nc">CacheableOperation</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">iterator</span><span class="o">().</span><span class="na">next</span><span class="o">();</span>
  			<span class="k">if</span> <span class="o">(</span><span class="n">isConditionPassing</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="nc">CacheOperationExpressionEvaluator</span><span class="o">.</span><span class="na">NO_RESULT</span><span class="o">))</span> <span class="o">{</span>
  				<span class="nc">Object</span> <span class="n">key</span> <span class="o">=</span> <span class="n">generateKey</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="nc">CacheOperationExpressionEvaluator</span><span class="o">.</span><span class="na">NO_RESULT</span><span class="o">);</span>
  				<span class="nc">Cache</span> <span class="n">cache</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="na">getCaches</span><span class="o">().</span><span class="na">iterator</span><span class="o">().</span><span class="na">next</span><span class="o">();</span>
  				<span class="k">try</span> <span class="o">{</span>
  					<span class="k">return</span> <span class="nf">wrapCacheValue</span><span class="o">(</span><span class="n">method</span><span class="o">,</span> <span class="n">cache</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="o">()</span> <span class="o">-&gt;</span> <span class="n">unwrapReturnValue</span><span class="o">(</span><span class="n">invokeOperation</span><span class="o">(</span><span class="n">invoker</span><span class="o">))));</span>
  				<span class="o">}</span>
  				<span class="k">catch</span> <span class="o">(</span><span class="nc">Cache</span><span class="o">.</span><span class="na">ValueRetrievalException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
  					<span class="c1">// The invoker wraps any Throwable in a ThrowableWrapper instance so we</span>
  					<span class="c1">// can just make sure that one bubbles up the stack.</span>
  					<span class="k">throw</span> <span class="o">(</span><span class="nc">CacheOperationInvoker</span><span class="o">.</span><span class="na">ThrowableWrapper</span><span class="o">)</span> <span class="n">ex</span><span class="o">.</span><span class="na">getCause</span><span class="o">();</span>
  				<span class="o">}</span>
  			<span class="o">}</span>
  			<span class="k">else</span> <span class="o">{</span>
  				<span class="c1">// No caching required, only call the underlying method</span>
  				<span class="k">return</span> <span class="nf">invokeOperation</span><span class="o">(</span><span class="n">invoker</span><span class="o">);</span>
  			<span class="o">}</span>
  		<span class="o">}</span>
  
  
  		<span class="c1">// Process any early evictions</span>
  		<span class="n">processCacheEvicts</span><span class="o">(</span><span class="n">contexts</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="nc">CacheEvictOperation</span><span class="o">.</span><span class="na">class</span><span class="o">),</span> <span class="kc">true</span><span class="o">,</span>
  				<span class="nc">CacheOperationExpressionEvaluator</span><span class="o">.</span><span class="na">NO_RESULT</span><span class="o">);</span>
  
  		<span class="c1">// Check if we have a cached item matching the conditions</span>
  		<span class="nc">Cache</span><span class="o">.</span><span class="na">ValueWrapper</span> <span class="n">cacheHit</span> <span class="o">=</span> <span class="n">findCachedItem</span><span class="o">(</span><span class="n">contexts</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="nc">CacheableOperation</span><span class="o">.</span><span class="na">class</span><span class="o">));</span>
  <span class="o">}</span>
  
  	<span class="nd">@Nullable</span>
  	<span class="kd">private</span> <span class="nc">Cache</span><span class="o">.</span><span class="na">ValueWrapper</span> <span class="nf">findCachedItem</span><span class="o">(</span><span class="nc">Collection</span><span class="o">&lt;</span><span class="nc">CacheOperationContext</span><span class="o">&gt;</span> <span class="n">contexts</span><span class="o">)</span> <span class="o">{</span>
  		<span class="nc">Object</span> <span class="n">result</span> <span class="o">=</span> <span class="nc">CacheOperationExpressionEvaluator</span><span class="o">.</span><span class="na">NO_RESULT</span><span class="o">;</span>
  		<span class="k">for</span> <span class="o">(</span><span class="nc">CacheOperationContext</span> <span class="n">context</span> <span class="o">:</span> <span class="n">contexts</span><span class="o">)</span> <span class="o">{</span>
  			<span class="k">if</span> <span class="o">(</span><span class="n">isConditionPassing</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="n">result</span><span class="o">))</span> <span class="o">{</span>
  				<span class="nc">Object</span> <span class="n">key</span> <span class="o">=</span> <span class="n">generateKey</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="n">result</span><span class="o">);</span>
  				<span class="nc">Cache</span><span class="o">.</span><span class="na">ValueWrapper</span> <span class="n">cached</span> <span class="o">=</span> <span class="n">findInCaches</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="n">key</span><span class="o">);</span>
  				<span class="k">if</span> <span class="o">(</span><span class="n">cached</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
  					<span class="k">return</span> <span class="n">cached</span><span class="o">;</span>
  				<span class="o">}</span>
  				<span class="k">else</span> <span class="o">{</span>
  					<span class="k">if</span> <span class="o">(</span><span class="n">logger</span><span class="o">.</span><span class="na">isTraceEnabled</span><span class="o">())</span> <span class="o">{</span>
  						<span class="n">logger</span><span class="o">.</span><span class="na">trace</span><span class="o">(</span><span class="s">"No cache entry for key '"</span> <span class="o">+</span> <span class="n">key</span> <span class="o">+</span> <span class="s">"' in cache(s) "</span> <span class="o">+</span> <span class="n">context</span><span class="o">.</span><span class="na">getCacheNames</span><span class="o">());</span>
  					<span class="o">}</span>
  				<span class="o">}</span>
  			<span class="o">}</span>
  		<span class="o">}</span>
  		<span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
  	<span class="o">}</span>
  
  	<span class="nd">@Nullable</span>
  	<span class="kd">private</span> <span class="nc">Cache</span><span class="o">.</span><span class="na">ValueWrapper</span> <span class="nf">findInCaches</span><span class="o">(</span><span class="nc">CacheOperationContext</span> <span class="n">context</span><span class="o">,</span> <span class="nc">Object</span> <span class="n">key</span><span class="o">)</span> <span class="o">{</span>
  		<span class="k">for</span> <span class="o">(</span><span class="nc">Cache</span> <span class="n">cache</span> <span class="o">:</span> <span class="n">context</span><span class="o">.</span><span class="na">getCaches</span><span class="o">())</span> <span class="o">{</span>
  			<span class="nc">Cache</span><span class="o">.</span><span class="na">ValueWrapper</span> <span class="n">wrapper</span> <span class="o">=</span> <span class="n">doGet</span><span class="o">(</span><span class="n">cache</span><span class="o">,</span> <span class="n">key</span><span class="o">);</span>
  			<span class="k">if</span> <span class="o">(</span><span class="n">wrapper</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
  				<span class="k">if</span> <span class="o">(</span><span class="n">logger</span><span class="o">.</span><span class="na">isTraceEnabled</span><span class="o">())</span> <span class="o">{</span>
  					<span class="n">logger</span><span class="o">.</span><span class="na">trace</span><span class="o">(</span><span class="s">"Cache entry for key '"</span> <span class="o">+</span> <span class="n">key</span> <span class="o">+</span> <span class="s">"' found in cache '"</span> <span class="o">+</span> <span class="n">cache</span><span class="o">.</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">"'"</span><span class="o">);</span>
  				<span class="o">}</span>
  				<span class="k">return</span> <span class="n">wrapper</span><span class="o">;</span>
  			<span class="o">}</span>
  		<span class="o">}</span>
  		<span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
  	<span class="o">}</span>
  
</code></pre>  </div></div> <div class="language-java highlighter-rouge notranslate"><div class="highlight">
<pre class="highlight"><code>  <span class="nc">AbstractCacheInvoker</span><span class="o">.</span><span class="na">java</span>
    	<span class="nd">@Nullable</span>
  	<span class="kd">protected</span> <span class="nc">Cache</span><span class="o">.</span><span class="na">ValueWrapper</span> <span class="nf">doGet</span><span class="o">(</span><span class="nc">Cache</span> <span class="n">cache</span><span class="o">,</span> <span class="nc">Object</span> <span class="n">key</span><span class="o">)</span> <span class="o">{</span>
  		<span class="k">try</span> <span class="o">{</span>
  			<span class="k">return</span> <span class="n">cache</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">key</span><span class="o">);</span>
  		<span class="o">}</span>
  		<span class="k">catch</span> <span class="o">(</span><span class="nc">RuntimeException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
  			<span class="n">getErrorHandler</span><span class="o">().</span><span class="na">handleCacheGetError</span><span class="o">(</span><span class="n">ex</span><span class="o">,</span> <span class="n">cache</span><span class="o">,</span> <span class="n">key</span><span class="o">);</span>
  			<span class="k">return</span> <span class="kc">null</span><span class="o">;</span>  <span class="c1">// If the exception is handled, return a cache miss</span>
  		<span class="o">}</span>
  	<span class="o">}</span>
</code></pre>  </div></div> <p>Cache.ValueWrapper.doGet()-&gt;Cache.get() Cache为interface，查看Cache的实现图，判断为AbstractValueAdaptingCache的实现。若无法判断为哪一个类的执行，则可通过debug定位追踪</p> <p><img src="https://img-blog.csdnimg.cn/bf9d79297801470b9dfc6bf683766b05.png#pic_left&amp;width=100" alt="在这里插入图片描述" style="zoom:50%;"></p> <p><img src="https://img-blog.csdnimg.cn/0b1c72807c484fdb8432bb4355e6b716.png#pic_left" alt="在这里插入图片描述"></p> <div class="language-java highlighter-rouge notranslate"><div class="highlight">
<pre class="highlight"><code><span class="nc">Cache</span><span class="o">.</span><span class="na">java</span>
  
<span class="nc">ValueWrapper</span> <span class="nf">get</span><span class="o">(</span><span class="nc">Object</span> <span class="n">key</span><span class="o">);</span>
</code></pre>  </div></div> <div class="language-java highlighter-rouge notranslate"><div class="highlight">
<pre class="highlight"><code>  <span class="nc">RedisCache</span><span class="o">.</span><span class="na">java</span>
    
  <span class="nd">@Override</span>
  <span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">"unchecked"</span><span class="o">)</span>
  <span class="nd">@Nullable</span>
  <span class="kd">public</span> <span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="no">T</span> <span class="nf">get</span><span class="o">(</span><span class="nc">Object</span> <span class="n">key</span><span class="o">,</span> <span class="nd">@Nullable</span> <span class="nc">Class</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="n">type</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">Object</span> <span class="n">value</span> <span class="o">=</span> <span class="n">fromStoreValue</span><span class="o">(</span><span class="n">lookup</span><span class="o">(</span><span class="n">key</span><span class="o">));</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">value</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">type</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">type</span><span class="o">.</span><span class="na">isInstance</span><span class="o">(</span><span class="n">value</span><span class="o">))</span> <span class="o">{</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalStateException</span><span class="o">(</span>
          <span class="s">"Cached value is not of required type ["</span> <span class="o">+</span> <span class="n">type</span><span class="o">.</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">"]: "</span> <span class="o">+</span> <span class="n">value</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="o">(</span><span class="no">T</span><span class="o">)</span> <span class="n">value</span><span class="o">;</span>
  <span class="o">}</span>
</code></pre>  </div></div> <p>Cache.get()-&gt;AbstractValueAdaptingCache.get()-&gt;fromStoreValue(lookup(key))-&gt;lookup() lookup的实现如图，其采用的方法为RedisCache <img src="https://img-blog.csdnimg.cn/2a22d44fb517423f8ea046f0c8ed0bb2.png#pic_left" alt="在这里插入图片描述"></p> <div class="language-java highlighter-rouge notranslate"><div class="highlight">
<pre class="highlight"><code>  <span class="nc">RedisCache</span><span class="o">.</span><span class="na">java</span>
  
    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="nc">Object</span> <span class="nf">lookup</span><span class="o">(</span><span class="nc">Object</span> <span class="n">key</span><span class="o">)</span> <span class="o">{</span>
  
      <span class="kt">byte</span><span class="o">[]</span> <span class="n">value</span> <span class="o">=</span> <span class="n">cacheWriter</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">name</span><span class="o">,</span> <span class="n">createAndConvertCacheKey</span><span class="o">(</span><span class="n">key</span><span class="o">));</span>
  
      <span class="k">if</span> <span class="o">(</span><span class="n">value</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
      <span class="o">}</span>
  
      <span class="k">return</span> <span class="nf">deserializeCacheValue</span><span class="o">(</span><span class="n">value</span><span class="o">);</span>
    <span class="o">}</span>
</code></pre>  </div></div> <p>RedisCache.lookup()-&gt;cacheWriter.get() cacheWriter(RedisCacheWriter)的实现默认只有一个DefaultRedisCacheWriter，IRedisCacheWriter为笔者添加的</p> <p><img src="https://img-blog.csdnimg.cn/a534282e95fb4ba5b5d9d2a0ca24aa91.png#pic_left" alt="在这里插入图片描述"></p> <div class="language-java highlighter-rouge notranslate"><div class="highlight">
<pre class="highlight"><code>    <span class="nc">DefaultRedisCacheWriter</span><span class="o">.</span><span class="na">java</span>
        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">byte</span><span class="o">[]</span> <span class="nf">get</span><span class="o">(</span><span class="nc">String</span> <span class="n">name</span><span class="o">,</span> <span class="kt">byte</span><span class="o">[]</span> <span class="n">key</span><span class="o">)</span> <span class="o">{</span>
        
            <span class="nc">Assert</span><span class="o">.</span><span class="na">notNull</span><span class="o">(</span><span class="n">name</span><span class="o">,</span> <span class="s">"Name must not be null!"</span><span class="o">);</span>
      <span class="nc">Assert</span><span class="o">.</span><span class="na">notNull</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="s">"Key must not be null!"</span><span class="o">);</span>
  
          <span class="k">return</span> <span class="nf">execute</span><span class="o">(</span><span class="n">name</span><span class="o">,</span> <span class="n">connection</span> <span class="o">-&gt;</span> <span class="n">connection</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">key</span><span class="o">));</span>
          <span class="o">}</span>
    
  
  <span class="kd">private</span> <span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="no">T</span> <span class="nf">execute</span><span class="o">(</span><span class="nc">String</span> <span class="n">name</span><span class="o">,</span> <span class="nc">Function</span><span class="o">&lt;</span><span class="nc">RedisConnection</span><span class="o">,</span> <span class="no">T</span><span class="o">&gt;</span> <span class="n">callback</span><span class="o">)</span> <span class="o">{</span>
          
              <span class="nc">RedisConnection</span> <span class="n">connection</span> <span class="o">=</span> <span class="n">connectionFactory</span><span class="o">.</span><span class="na">getConnection</span><span class="o">();</span>
          <span class="k">try</span> <span class="o">{</span>
          
                  <span class="n">checkAndPotentiallyWaitUntilUnlocked</span><span class="o">(</span><span class="n">name</span><span class="o">,</span> <span class="n">connection</span><span class="o">);</span>
                  <span class="k">return</span> <span class="n">callback</span><span class="o">.</span><span class="na">apply</span><span class="o">(</span><span class="n">connection</span><span class="o">);</span>
              <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
              <span class="n">connection</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
          <span class="o">}</span>
          <span class="o">}</span>
</code></pre>  </div></div> <p>DefaultRedisCacheWriter.get()-&gt;execute()-&gt;connectionFactory.getConnection() connectionFactory默认实现有两个，JedisSelfConnectionFactory为笔者实现的，该处为JedisConnectionFactory</p> <p><em>JedisConnectionFactory时序图参考</em></p> <p><img src="https://img-blog.csdnimg.cn/f2845e727cb94bb08de954fd2ba01b3d.jpeg#pic_center" alt="在这里插入图片描述"></p> <p><img src="https://img-blog.csdnimg.cn/4ff20337c2bf4c8097dac530226c797e.png#pic_left" alt="在这里插入图片描述"></p> <p>JedisConnectionFactory.getConnection()-&gt;fetchJedisConnector()-&gt;pool.getResource()</p> <div class="language-java highlighter-rouge notranslate"><div class="highlight">
<pre class="highlight"><code>  	<span class="nc">JedisConnectionFactory</span><span class="o">.</span><span class="na">java</span>
  <span class="kd">public</span> <span class="nc">RedisConnection</span> <span class="nf">getConnection</span><span class="o">()</span> <span class="o">{</span>
  
  	<span class="k">if</span> <span class="o">(</span><span class="n">isRedisClusterAware</span><span class="o">())</span> <span class="o">{</span>
  		<span class="k">return</span> <span class="nf">getClusterConnection</span><span class="o">();</span>
  	<span class="o">}</span>
  	
  	<span class="nc">Jedis</span> <span class="n">jedis</span> <span class="o">=</span> <span class="n">fetchJedisConnector</span><span class="o">();</span>
  	<span class="nc">String</span> <span class="n">clientName</span> <span class="o">=</span> <span class="n">clientConfiguration</span><span class="o">.</span><span class="na">getClientName</span><span class="o">().</span><span class="na">orElse</span><span class="o">(</span><span class="kc">null</span><span class="o">);</span>
  <span class="nc">JedisConnection</span> <span class="n">connection</span> <span class="o">=</span> <span class="o">(</span><span class="n">getUsePool</span><span class="o">()</span> <span class="o">?</span> <span class="k">new</span> <span class="nc">JedisConnection</span><span class="o">(</span><span class="n">jedis</span><span class="o">,</span> <span class="n">pool</span><span class="o">,</span> <span class="n">getDatabase</span><span class="o">(),</span> <span class="n">clientName</span><span class="o">)</span>
  			<span class="o">:</span> <span class="k">new</span> <span class="nc">JedisConnection</span><span class="o">(</span><span class="n">jedis</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="n">getDatabase</span><span class="o">(),</span> <span class="n">clientName</span><span class="o">));</span>
  	<span class="n">connection</span><span class="o">.</span><span class="na">setConvertPipelineAndTxResults</span><span class="o">(</span><span class="n">convertPipelineAndTxResults</span><span class="o">);</span>
  <span class="k">return</span> <span class="nf">postProcessConnection</span><span class="o">(</span><span class="n">connection</span><span class="o">);</span>
  <span class="o">}</span>
  
  <span class="kd">protected</span> <span class="nc">Jedis</span> <span class="nf">fetchJedisConnector</span><span class="o">()</span> <span class="o">{</span>
  <span class="k">try</span> <span class="o">{</span>
  
  		<span class="k">if</span> <span class="o">(</span><span class="n">getUsePool</span><span class="o">()</span> <span class="o">&amp;&amp;</span> <span class="n">pool</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
  			<span class="k">return</span> <span class="n">pool</span><span class="o">.</span><span class="na">getResource</span><span class="o">();</span>
  	<span class="o">}</span>
  	
  		<span class="nc">Jedis</span> <span class="n">jedis</span> <span class="o">=</span> <span class="n">createJedis</span><span class="o">();</span>
  		<span class="c1">// force initialization (see Jedis issue #82)</span>
  		<span class="n">jedis</span><span class="o">.</span><span class="na">connect</span><span class="o">();</span>
  	
  		<span class="n">potentiallySetClientName</span><span class="o">(</span><span class="n">jedis</span><span class="o">);</span>
  		<span class="k">return</span> <span class="n">jedis</span><span class="o">;</span>
  <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
  	<span class="k">throw</span> <span class="k">new</span> <span class="nf">RedisConnectionFailureException</span><span class="o">(</span><span class="s">"Cannot get Jedis connection"</span><span class="o">,</span> <span class="n">ex</span><span class="o">);</span>
  <span class="o">}</span>
  <span class="o">}</span>
</code></pre>  </div></div> <p>pool.getResource() pool有三个子类实现，该处为JedisPool，pool.getResource()-&gt;GenericObjectPool.borrowObject() 在该方法中，我们看到了底层堆栈抛出的异常"Timeout waiting for idle object" 至此，整个源码过程追踪完毕，这也符合我们从日志中查看到的堆栈信息。那么现在的问题核心就是分析GenericObjectPool.borrowObject()中异常为何抛出了。</p> <p><img src="https://img-blog.csdnimg.cn/6dec3f8404bd40658b3bb565ed4c4219.png#pic_left" alt="在这里插入图片描述"></p> <div class="language-java highlighter-rouge notranslate"><div class="highlight">
<pre class="highlight"><code>  <span class="nc">Pool</span><span class="o">.</span><span class="na">java</span>
  <span class="kd">public</span> <span class="no">T</span> <span class="nf">getResource</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">try</span> <span class="o">{</span>
      <span class="k">return</span> <span class="n">internalPool</span><span class="o">.</span><span class="na">borrowObject</span><span class="o">();</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">NoSuchElementException</span> <span class="n">nse</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nf">JedisException</span><span class="o">(</span><span class="s">"Could not get a resource from the pool"</span><span class="o">,</span> <span class="n">nse</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nf">JedisConnectionException</span><span class="o">(</span><span class="s">"Could not get a resource from the pool"</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
    <span class="o">}</span>
  <span class="o">}</span>
</code></pre>  </div></div> <div class="language-java highlighter-rouge notranslate"><div class="highlight">
<pre class="highlight"><code><span class="nc">GenericObjectPool</span><span class="o">.</span><span class="na">java</span>
  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="no">T</span> <span class="nf">borrowObject</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
      <span class="k">return</span> <span class="nf">borrowObject</span><span class="o">(</span><span class="n">getMaxWaitMillis</span><span class="o">());</span>
  <span class="o">}</span>
  
   <span class="kd">public</span> <span class="no">T</span> <span class="nf">borrowObject</span><span class="o">(</span><span class="kd">final</span> <span class="kt">long</span> <span class="n">borrowMaxWaitMillis</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
          <span class="n">assertOpen</span><span class="o">();</span>
  
          <span class="kd">final</span> <span class="nc">AbandonedConfig</span> <span class="n">ac</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">abandonedConfig</span><span class="o">;</span>
          <span class="k">if</span> <span class="o">(</span><span class="n">ac</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">ac</span><span class="o">.</span><span class="na">getRemoveAbandonedOnBorrow</span><span class="o">()</span> <span class="o">&amp;&amp;</span>
                  <span class="o">(</span><span class="n">getNumIdle</span><span class="o">()</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="o">)</span> <span class="o">&amp;&amp;</span>
                  <span class="o">(</span><span class="n">getNumActive</span><span class="o">()</span> <span class="o">&gt;</span> <span class="n">getMaxTotal</span><span class="o">()</span> <span class="o">-</span> <span class="mi">3</span><span class="o">)</span> <span class="o">)</span> <span class="o">{</span>
              <span class="n">removeAbandoned</span><span class="o">(</span><span class="n">ac</span><span class="o">);</span>
          <span class="o">}</span>
      
          <span class="nc">PooledObject</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="n">p</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
      
          <span class="c1">// Get local copy of current config so it is consistent for entire</span>
          <span class="c1">// method execution</span>
          <span class="kd">final</span> <span class="kt">boolean</span> <span class="n">blockWhenExhausted</span> <span class="o">=</span> <span class="n">getBlockWhenExhausted</span><span class="o">();</span>
      
          <span class="kt">boolean</span> <span class="n">create</span><span class="o">;</span>
          <span class="kd">final</span> <span class="kt">long</span> <span class="n">waitTime</span> <span class="o">=</span> <span class="nc">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">();</span>
      
          <span class="k">while</span> <span class="o">(</span><span class="n">p</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
              <span class="n">create</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
              <span class="n">p</span> <span class="o">=</span> <span class="n">idleObjects</span><span class="o">.</span><span class="na">pollFirst</span><span class="o">();</span>
              <span class="k">if</span> <span class="o">(</span><span class="n">p</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                  <span class="n">p</span> <span class="o">=</span> <span class="n">create</span><span class="o">();</span>
                  <span class="k">if</span> <span class="o">(</span><span class="n">p</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                      <span class="n">create</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
                  <span class="o">}</span>
              <span class="o">}</span>
              <span class="k">if</span> <span class="o">(</span><span class="n">blockWhenExhausted</span><span class="o">)</span> <span class="o">{</span>
                  <span class="k">if</span> <span class="o">(</span><span class="n">p</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                      <span class="k">if</span> <span class="o">(</span><span class="n">borrowMaxWaitMillis</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
                          <span class="n">p</span> <span class="o">=</span> <span class="n">idleObjects</span><span class="o">.</span><span class="na">takeFirst</span><span class="o">();</span>
                      <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                          <span class="n">p</span> <span class="o">=</span> <span class="n">idleObjects</span><span class="o">.</span><span class="na">pollFirst</span><span class="o">(</span><span class="n">borrowMaxWaitMillis</span><span class="o">,</span>
                                  <span class="nc">TimeUnit</span><span class="o">.</span><span class="na">MILLISECONDS</span><span class="o">);</span>
                      <span class="o">}</span>
                  <span class="o">}</span>
                  <span class="k">if</span> <span class="o">(</span><span class="n">p</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                      <span class="k">throw</span> <span class="k">new</span> <span class="nf">NoSuchElementException</span><span class="o">(</span>
                              <span class="s">"Timeout waiting for idle object"</span><span class="o">);</span>
                  <span class="o">}</span>
              <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                  <span class="k">if</span> <span class="o">(</span><span class="n">p</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                      <span class="k">throw</span> <span class="k">new</span> <span class="nf">NoSuchElementException</span><span class="o">(</span><span class="s">"Pool exhausted"</span><span class="o">);</span>
                  <span class="o">}</span>
              <span class="o">}</span>
              <span class="k">if</span> <span class="o">(!</span><span class="n">p</span><span class="o">.</span><span class="na">allocate</span><span class="o">())</span> <span class="o">{</span>
                  <span class="n">p</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
              <span class="o">}</span>
      
              <span class="k">if</span> <span class="o">(</span><span class="n">p</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                  <span class="k">try</span> <span class="o">{</span>
                      <span class="n">factory</span><span class="o">.</span><span class="na">activateObject</span><span class="o">(</span><span class="n">p</span><span class="o">);</span>
                  <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="kd">final</span> <span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                      <span class="k">try</span> <span class="o">{</span>
                          <span class="n">destroy</span><span class="o">(</span><span class="n">p</span><span class="o">);</span>
                      <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="kd">final</span> <span class="nc">Exception</span> <span class="n">e1</span><span class="o">)</span> <span class="o">{</span>
                          <span class="c1">// Ignore - activation failure is more important</span>
                      <span class="o">}</span>
                      <span class="n">p</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
                      <span class="k">if</span> <span class="o">(</span><span class="n">create</span><span class="o">)</span> <span class="o">{</span>
                          <span class="kd">final</span> <span class="nc">NoSuchElementException</span> <span class="n">nsee</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">NoSuchElementException</span><span class="o">(</span>
                                  <span class="s">"Unable to activate object"</span><span class="o">);</span>
                          <span class="n">nsee</span><span class="o">.</span><span class="na">initCause</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
                          <span class="k">throw</span> <span class="n">nsee</span><span class="o">;</span>
                      <span class="o">}</span>
                  <span class="o">}</span>
                  <span class="k">if</span> <span class="o">(</span><span class="n">p</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="o">(</span><span class="n">getTestOnBorrow</span><span class="o">()</span> <span class="o">||</span> <span class="n">create</span> <span class="o">&amp;&amp;</span> <span class="n">getTestOnCreate</span><span class="o">()))</span> <span class="o">{</span>
                      <span class="kt">boolean</span> <span class="n">validate</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
                      <span class="nc">Throwable</span> <span class="n">validationThrowable</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
                      <span class="k">try</span> <span class="o">{</span>
                          <span class="n">validate</span> <span class="o">=</span> <span class="n">factory</span><span class="o">.</span><span class="na">validateObject</span><span class="o">(</span><span class="n">p</span><span class="o">);</span>
                      <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="kd">final</span> <span class="nc">Throwable</span> <span class="n">t</span><span class="o">)</span> <span class="o">{</span>
                          <span class="nc">PoolUtils</span><span class="o">.</span><span class="na">checkRethrow</span><span class="o">(</span><span class="n">t</span><span class="o">);</span>
                          <span class="n">validationThrowable</span> <span class="o">=</span> <span class="n">t</span><span class="o">;</span>
                      <span class="o">}</span>
                      <span class="k">if</span> <span class="o">(!</span><span class="n">validate</span><span class="o">)</span> <span class="o">{</span>
                          <span class="k">try</span> <span class="o">{</span>
                              <span class="n">destroy</span><span class="o">(</span><span class="n">p</span><span class="o">);</span>
                              <span class="n">destroyedByBorrowValidationCount</span><span class="o">.</span><span class="na">incrementAndGet</span><span class="o">();</span>
                          <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="kd">final</span> <span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                              <span class="c1">// Ignore - validation failure is more important</span>
                          <span class="o">}</span>
                          <span class="n">p</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
                          <span class="k">if</span> <span class="o">(</span><span class="n">create</span><span class="o">)</span> <span class="o">{</span>
                              <span class="kd">final</span> <span class="nc">NoSuchElementException</span> <span class="n">nsee</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">NoSuchElementException</span><span class="o">(</span>
                                      <span class="s">"Unable to validate object"</span><span class="o">);</span>
                              <span class="n">nsee</span><span class="o">.</span><span class="na">initCause</span><span class="o">(</span><span class="n">validationThrowable</span><span class="o">);</span>
                              <span class="k">throw</span> <span class="n">nsee</span><span class="o">;</span>
                          <span class="o">}</span>
                      <span class="o">}</span>
                  <span class="o">}</span>
              <span class="o">}</span>
          <span class="o">}</span>
      
          <span class="n">updateStatsBorrow</span><span class="o">(</span><span class="n">p</span><span class="o">,</span> <span class="nc">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">()</span> <span class="o">-</span> <span class="n">waitTime</span><span class="o">);</span>
      
          <span class="k">return</span> <span class="n">p</span><span class="o">.</span><span class="na">getObject</span><span class="o">();</span>
      <span class="o">}</span>
</code></pre>  </div></div> <p>分析抛出异常的代码块，Debug到该段代码块</p> <div class="language-java highlighter-rouge notranslate"><div class="highlight">
<pre class="highlight"><code><span class="nc">GenericObjectPool</span><span class="o">.</span><span class="na">borrowObject</span><span class="o">()</span>        
<span class="k">if</span> <span class="o">(</span><span class="n">blockWhenExhausted</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">p</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">borrowMaxWaitMillis</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
                    <span class="c1">// 空闲队列中获取空闲对象 一直等待 </span>
                    <span class="n">p</span> <span class="o">=</span> <span class="n">idleObjects</span><span class="o">.</span><span class="na">takeFirst</span><span class="o">();</span>
                <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                    <span class="c1">// 等待borrowMaxWaitMillis ms后,放弃 该参数即对应redis中的配置 max-wait</span>
                    <span class="n">p</span> <span class="o">=</span> <span class="n">idleObjects</span><span class="o">.</span><span class="na">pollFirst</span><span class="o">(</span><span class="n">borrowMaxWaitMillis</span><span class="o">,</span>
                            <span class="nc">TimeUnit</span><span class="o">.</span><span class="na">MILLISECONDS</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">}</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">p</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nf">NoSuchElementException</span><span class="o">(</span>
                        <span class="s">"Timeout waiting for idle object"</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
</code></pre>  </div></div> <p><img src="https://img-blog.csdnimg.cn/5012d288b2a74bc4a86cdec8890e15f4.png#pic_left" alt="在这里插入图片描述"> <img src="https://img-blog.csdnimg.cn/4e9b0dff532e4360b597f51a8d420325.png#pic_left" alt="在这里插入图片描述"></p> <blockquote> <p>观察发现，该对象中的allObject已经都是被分配(ALLOCATED)状态，因此当程序继续请求，都将报错。</p> </blockquote> <blockquote> <p>也许你有这样的疑问，程序已经不在使用redis连接池中的连接，而且Redis服务端也显示客户端未占用连接来，为何应用中对象未被释放，reidis中不是默认会有闲时检测么（关于redis的配置参考<a href="../java/redis-config">Redis配置解读</a>），我们进一步探究</p> </blockquote> <p>reidis中的闲时检测，是基于BaseGenericObjectPool.java中的定时线程实现，主要关注evict()方法</p> <div class="language-java highlighter-rouge notranslate"><div class="highlight">
<pre class="highlight"><code>  <span class="nc">BaseGenericObjectPool</span><span class="o">.</span><span class="na">java</span>
  <span class="cm">/**
       * The idle object evictor {@link TimerTask}.
       *
       * @see GenericKeyedObjectPool#setTimeBetweenEvictionRunsMillis
       */</span>
      <span class="kd">class</span> <span class="nc">Evictor</span> <span class="kd">implements</span> <span class="nc">Runnable</span> <span class="o">{</span>
  
          <span class="kd">private</span> <span class="nc">ScheduledFuture</span><span class="o">&lt;?&gt;</span> <span class="n">scheduledFuture</span><span class="o">;</span>
  
          <span class="cm">/**
           * Run pool maintenance.  Evict objects qualifying for eviction and then
           * ensure that the minimum number of idle instances are available.
           * Since the Timer that invokes Evictors is shared for all Pools but
           * pools may exist in different class loaders, the Evictor ensures that
           * any actions taken are under the class loader of the factory
           * associated with the pool.
           */</span>
          <span class="nd">@Override</span>
          <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
              <span class="kd">final</span> <span class="nc">ClassLoader</span> <span class="n">savedClassLoader</span> <span class="o">=</span>
                      <span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getContextClassLoader</span><span class="o">();</span>
              <span class="k">try</span> <span class="o">{</span>
                  <span class="k">if</span> <span class="o">(</span><span class="n">factoryClassLoader</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                      <span class="c1">// Set the class loader for the factory</span>
                      <span class="kd">final</span> <span class="nc">ClassLoader</span> <span class="n">cl</span> <span class="o">=</span> <span class="n">factoryClassLoader</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
                      <span class="k">if</span> <span class="o">(</span><span class="n">cl</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                          <span class="c1">// The pool has been dereferenced and the class loader</span>
                          <span class="c1">// GC'd. Cancel this timer so the pool can be GC'd as</span>
                          <span class="c1">// well.</span>
                          <span class="n">cancel</span><span class="o">();</span>
                          <span class="k">return</span><span class="o">;</span>
                      <span class="o">}</span>
                      <span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">setContextClassLoader</span><span class="o">(</span><span class="n">cl</span><span class="o">);</span>
                  <span class="o">}</span>
  
                  <span class="c1">// Evict from the pool</span>
                  <span class="k">try</span> <span class="o">{</span>
                      <span class="n">evict</span><span class="o">();</span>
                  <span class="o">}</span> <span class="k">catch</span><span class="o">(</span><span class="kd">final</span> <span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                      <span class="n">swallowException</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
                  <span class="o">}</span> <span class="k">catch</span><span class="o">(</span><span class="kd">final</span> <span class="nc">OutOfMemoryError</span> <span class="n">oome</span><span class="o">)</span> <span class="o">{</span>
                      <span class="c1">// Log problem but give evictor thread a chance to continue</span>
                      <span class="c1">// in case error is recoverable</span>
                      <span class="n">oome</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">(</span><span class="nc">System</span><span class="o">.</span><span class="na">err</span><span class="o">);</span>
                  <span class="o">}</span>
                  <span class="c1">// Re-create idle instances.</span>
                  <span class="k">try</span> <span class="o">{</span>
                      <span class="n">ensureMinIdle</span><span class="o">();</span>
                  <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="kd">final</span> <span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                      <span class="n">swallowException</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
                  <span class="o">}</span>
              <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
                  <span class="c1">// Restore the previous CCL</span>
                  <span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">setContextClassLoader</span><span class="o">(</span><span class="n">savedClassLoader</span><span class="o">);</span>
              <span class="o">}</span>
          <span class="o">}</span>
  
  
          <span class="kt">void</span> <span class="nf">setScheduledFuture</span><span class="o">(</span><span class="kd">final</span> <span class="nc">ScheduledFuture</span><span class="o">&lt;?&gt;</span> <span class="n">scheduledFuture</span><span class="o">)</span> <span class="o">{</span>
              <span class="k">this</span><span class="o">.</span><span class="na">scheduledFuture</span> <span class="o">=</span> <span class="n">scheduledFuture</span><span class="o">;</span>
          <span class="o">}</span>
  
  
          <span class="kt">void</span> <span class="nf">cancel</span><span class="o">()</span> <span class="o">{</span>
              <span class="n">scheduledFuture</span><span class="o">.</span><span class="na">cancel</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
          <span class="o">}</span>
      <span class="o">}</span>
</code></pre>  </div></div> <p>evict()方法中，我们发现第一步的清理基于有空闲对象的基础上执行，而在上述Debug过程中，我们发现borrowObject已经无空闲资源了，因此对象无法被触发回收。 还有一个清理对象是基于AbandonConfig进行的。针对此配置下面叙述。</p> <div class="language-java highlighter-rouge notranslate"><div class="highlight">
<pre class="highlight"><code><span class="nc">GenericObjectPool</span><span class="o">.</span><span class="na">java</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">evict</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
    <span class="n">assertOpen</span><span class="o">();</span>

    <span class="k">if</span> <span class="o">(</span><span class="n">idleObjects</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
  
        <span class="nc">PooledObject</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="n">underTest</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="kd">final</span> <span class="nc">EvictionPolicy</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="n">evictionPolicy</span> <span class="o">=</span> <span class="n">getEvictionPolicy</span><span class="o">();</span>
  
        <span class="kd">synchronized</span> <span class="o">(</span><span class="n">evictionLock</span><span class="o">)</span> <span class="o">{</span>
            <span class="kd">final</span> <span class="nc">EvictionConfig</span> <span class="n">evictionConfig</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">EvictionConfig</span><span class="o">(</span>
                    <span class="n">getMinEvictableIdleTimeMillis</span><span class="o">(),</span>
                    <span class="n">getSoftMinEvictableIdleTimeMillis</span><span class="o">(),</span>
                    <span class="n">getMinIdle</span><span class="o">());</span>
  
            <span class="kd">final</span> <span class="kt">boolean</span> <span class="n">testWhileIdle</span> <span class="o">=</span> <span class="n">getTestWhileIdle</span><span class="o">();</span>
  
            <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">,</span> <span class="n">m</span> <span class="o">=</span> <span class="n">getNumTests</span><span class="o">();</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">m</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">evictionIterator</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="o">!</span><span class="n">evictionIterator</span><span class="o">.</span><span class="na">hasNext</span><span class="o">())</span> <span class="o">{</span>
                    <span class="n">evictionIterator</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">EvictionIterator</span><span class="o">(</span><span class="n">idleObjects</span><span class="o">);</span>
                <span class="o">}</span>
                <span class="k">if</span> <span class="o">(!</span><span class="n">evictionIterator</span><span class="o">.</span><span class="na">hasNext</span><span class="o">())</span> <span class="o">{</span>
                    <span class="c1">// Pool exhausted, nothing to do here</span>
                    <span class="k">return</span><span class="o">;</span>
                <span class="o">}</span>
  
                <span class="k">try</span> <span class="o">{</span>
                    <span class="n">underTest</span> <span class="o">=</span> <span class="n">evictionIterator</span><span class="o">.</span><span class="na">next</span><span class="o">();</span>
                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="kd">final</span> <span class="nc">NoSuchElementException</span> <span class="n">nsee</span><span class="o">)</span> <span class="o">{</span>
                    <span class="c1">// Object was borrowed in another thread</span>
                    <span class="c1">// Don't count this as an eviction test so reduce i;</span>
                    <span class="n">i</span><span class="o">--;</span>
                    <span class="n">evictionIterator</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
                    <span class="k">continue</span><span class="o">;</span>
                <span class="o">}</span>
  
                <span class="k">if</span> <span class="o">(!</span><span class="n">underTest</span><span class="o">.</span><span class="na">startEvictionTest</span><span class="o">())</span> <span class="o">{</span>
                    <span class="c1">// Object was borrowed in another thread</span>
                    <span class="c1">// Don't count this as an eviction test so reduce i;</span>
                    <span class="n">i</span><span class="o">--;</span>
                    <span class="k">continue</span><span class="o">;</span>
                <span class="o">}</span>
  
                <span class="c1">// User provided eviction policy could throw all sorts of</span>
                <span class="c1">// crazy exceptions. Protect against such an exception</span>
                <span class="c1">// killing the eviction thread.</span>
                <span class="kt">boolean</span> <span class="n">evict</span><span class="o">;</span>
                <span class="k">try</span> <span class="o">{</span>
                    <span class="n">evict</span> <span class="o">=</span> <span class="n">evictionPolicy</span><span class="o">.</span><span class="na">evict</span><span class="o">(</span><span class="n">evictionConfig</span><span class="o">,</span> <span class="n">underTest</span><span class="o">,</span>
                            <span class="n">idleObjects</span><span class="o">.</span><span class="na">size</span><span class="o">());</span>
                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="kd">final</span> <span class="nc">Throwable</span> <span class="n">t</span><span class="o">)</span> <span class="o">{</span>
                    <span class="c1">// Slightly convoluted as SwallowedExceptionListener</span>
                    <span class="c1">// uses Exception rather than Throwable</span>
                    <span class="nc">PoolUtils</span><span class="o">.</span><span class="na">checkRethrow</span><span class="o">(</span><span class="n">t</span><span class="o">);</span>
                    <span class="n">swallowException</span><span class="o">(</span><span class="k">new</span> <span class="nc">Exception</span><span class="o">(</span><span class="n">t</span><span class="o">));</span>
                    <span class="c1">// Don't evict on error conditions</span>
                    <span class="n">evict</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
                <span class="o">}</span>
  
                <span class="k">if</span> <span class="o">(</span><span class="n">evict</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">destroy</span><span class="o">(</span><span class="n">underTest</span><span class="o">);</span>
                    <span class="n">destroyedByEvictorCount</span><span class="o">.</span><span class="na">incrementAndGet</span><span class="o">();</span>
                <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">testWhileIdle</span><span class="o">)</span> <span class="o">{</span>
                        <span class="kt">boolean</span> <span class="n">active</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
                        <span class="k">try</span> <span class="o">{</span>
                            <span class="n">factory</span><span class="o">.</span><span class="na">activateObject</span><span class="o">(</span><span class="n">underTest</span><span class="o">);</span>
                            <span class="n">active</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
                        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="kd">final</span> <span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                            <span class="n">destroy</span><span class="o">(</span><span class="n">underTest</span><span class="o">);</span>
                            <span class="n">destroyedByEvictorCount</span><span class="o">.</span><span class="na">incrementAndGet</span><span class="o">();</span>
                        <span class="o">}</span>
                        <span class="k">if</span> <span class="o">(</span><span class="n">active</span><span class="o">)</span> <span class="o">{</span>
                            <span class="k">if</span> <span class="o">(!</span><span class="n">factory</span><span class="o">.</span><span class="na">validateObject</span><span class="o">(</span><span class="n">underTest</span><span class="o">))</span> <span class="o">{</span>
                                <span class="n">destroy</span><span class="o">(</span><span class="n">underTest</span><span class="o">);</span>
                                <span class="n">destroyedByEvictorCount</span><span class="o">.</span><span class="na">incrementAndGet</span><span class="o">();</span>
                            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                                <span class="k">try</span> <span class="o">{</span>
                                    <span class="n">factory</span><span class="o">.</span><span class="na">passivateObject</span><span class="o">(</span><span class="n">underTest</span><span class="o">);</span>
                                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="kd">final</span> <span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                                    <span class="n">destroy</span><span class="o">(</span><span class="n">underTest</span><span class="o">);</span>
                                    <span class="n">destroyedByEvictorCount</span><span class="o">.</span><span class="na">incrementAndGet</span><span class="o">();</span>
                                <span class="o">}</span>
                            <span class="o">}</span>
                        <span class="o">}</span>
                    <span class="o">}</span>
                    <span class="k">if</span> <span class="o">(!</span><span class="n">underTest</span><span class="o">.</span><span class="na">endEvictionTest</span><span class="o">(</span><span class="n">idleObjects</span><span class="o">))</span> <span class="o">{</span>
                        <span class="c1">// TODO - May need to add code here once additional</span>
                        <span class="c1">// states are used</span>
                    <span class="o">}</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="kd">final</span> <span class="nc">AbandonedConfig</span> <span class="n">ac</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">abandonedConfig</span><span class="o">;</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">ac</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">ac</span><span class="o">.</span><span class="na">getRemoveAbandonedOnMaintenance</span><span class="o">())</span> <span class="o">{</span>
        <span class="n">removeAbandoned</span><span class="o">(</span><span class="n">ac</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre>  </div></div> <p><img src="https://img-blog.csdnimg.cn/6696d8523c7a4c6ebceb08e7f60d4727.png#pic_center" alt="在这里插入图片描述" style="zoom: 33%;"></p> <h3 id="初步总结">初步总结</h3> <blockquote> <p>通过Debug，我们推断问题的发生是GenericObjectPool的allObject都已经处于Allocated状态，导致异常抛出。那么要解决该问题，可以通过触发释放对象。当然这仅仅是针对问题，解决表象的思路。</p> <p><strong><font color="red">2022-12-16补充：</font></strong>也许你还有这样的疑问：既然连接未创建成功，这些被分配的对象又是如何来的？这些对象创建后，又是哪里被回收或者丢弃的？</p> <p>答：我们分析源码得知在connectionFactory获取connection过程中，若使用连接池，会使用GenericObjectPool.borrowObject()，只有成功获取对象，才认为连接创建成功，从而执行命令，关闭连接，并返还或销毁对象，执行JedisConnection.close()-&gt;jedis.close()方法；而在2.9.1版本中jedis.close()方法是存在jedis对象泄漏的，关于泄漏问题，请参考<a href="../java/jedis-pool">低版本中Jedis对象泄漏证明及探究</a>。</p> <p>Ps: 在之前的分析中，未深入分析Jedis对象泄漏问题，因此临时通过AbandonConfig配置，主动释放对象。</p> </blockquote> <p>那么我们有没有其他方法进行设置，触发释放呢？</p> <p>关注两块代码 borrowObject()和evict()方法中都有 AbandonedConfig这个配置；关于这个配置可以阅读源码注释；这是个能在获取连接的时候就进行分配对象舍弃的设置。</p> <div class="language-java highlighter-rouge notranslate"><div class="highlight">
<pre class="highlight"><code>        <span class="nc">GenericObjectPool</span><span class="o">.</span><span class="na">java</span>  
        <span class="kd">public</span> <span class="no">T</span> <span class="nf">borrowObject</span><span class="o">(</span><span class="kd">final</span> <span class="kt">long</span> <span class="n">borrowMaxWaitMillis</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
            <span class="n">assertOpen</span><span class="o">();</span>
  
            <span class="kd">final</span> <span class="nc">AbandonedConfig</span> <span class="n">ac</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">abandonedConfig</span><span class="o">;</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">ac</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">ac</span><span class="o">.</span><span class="na">getRemoveAbandonedOnBorrow</span><span class="o">()</span> <span class="o">&amp;&amp;</span>
                    <span class="o">(</span><span class="n">getNumIdle</span><span class="o">()</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="o">)</span> <span class="o">&amp;&amp;</span>
                    <span class="o">(</span><span class="n">getNumActive</span><span class="o">()</span> <span class="o">&gt;</span> <span class="n">getMaxTotal</span><span class="o">()</span> <span class="o">-</span> <span class="mi">3</span><span class="o">)</span> <span class="o">)</span> <span class="o">{</span>
                <span class="n">removeAbandoned</span><span class="o">(</span><span class="n">ac</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="c1">// ...</span>
        <span class="o">}</span>
        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">evict</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
          <span class="c1">// ...</span>
            <span class="kd">final</span> <span class="nc">AbandonedConfig</span> <span class="n">ac</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">abandonedConfig</span><span class="o">;</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">ac</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">ac</span><span class="o">.</span><span class="na">getRemoveAbandonedOnMaintenance</span><span class="o">())</span> <span class="o">{</span>
                <span class="n">removeAbandoned</span><span class="o">(</span><span class="n">ac</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
</code></pre>  </div></div> <p>直接修改此段代码，给AbandonConfig赋值。关于如何修改依赖jar的源码请参考<a href="../tool/idea-jar-debug">IDEA引入源码包修改调试</a></p> <p>按相同的并发操作步骤，仅给AbandonConfig赋值，测试问题是否可以得到解决；测试结果如下图，可以发现，程序进入后释放了占用对象，并在并发结束后，仍能正常提供服务。</p> <div class="language-java highlighter-rouge notranslate"><div class="highlight">
<pre class="highlight"><code>  <span class="nc">AbandonedConfig</span> <span class="n">abandonedConfig</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">AbandonedConfig</span><span class="o">();</span>
  <span class="n">abandonedConfig</span><span class="o">.</span><span class="na">setLogAbandoned</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
  <span class="n">abandonedConfig</span><span class="o">.</span><span class="na">setRemoveAbandonedOnBorrow</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
</code></pre>  </div></div> <p><img src="https://img-blog.csdnimg.cn/b55eec738ab144e48ce3ef3c8b803959.png#pic_left" alt="在这里插入图片描述" style="zoom:50%;margin:0px"></p> <blockquote> <p>redis为何未暴露AandonConfig配置，请参考<a href="../java/redis-config">Redis配置解读</a>；</p> </blockquote> <blockquote> <p>简单说明，3版本Jedis未提供设置方法，4版本提供，但需要SpringBoot同步升级到3版本以上，且该配置通过pool对象设置</p> </blockquote> <p>引申的问题：若我们强制给AbandonConfig赋值，是否合理，会有什么弊端？</p> <h2 id="解决方案">解决方案</h2> <ol> <li> <p>升级Jedis版本 <strong><font color="red">推荐</font></strong> jedis版本要3.6.0以上，主要关注源码包中下面代码</p> <div class="language-java highlighter-rouge notranslate">
<div class="highlight">
<pre class="highlight"><code>  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">close</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">dataSource</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
      <span class="nc">JedisPoolAbstract</span> <span class="n">pool</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">dataSource</span><span class="o">;</span>
      <span class="k">this</span><span class="o">.</span><span class="na">dataSource</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">isBroken</span><span class="o">())</span> <span class="o">{</span>
        <span class="n">pool</span><span class="o">.</span><span class="na">returnBrokenResource</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
      <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
        <span class="n">pool</span><span class="o">.</span><span class="na">returnResource</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
      <span class="o">}</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
      <span class="kd">super</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
    <span class="o">}</span>
  <span class="o">}</span>
</code></pre>  </div> </div> <p>官方网址：<a href="https://hub.nuaa.cf/redis/jedis/blob/jedis-3.6.0/src/main/java/redis/clients/jedis/Jedis.java">jedis-3.6.0</a></p> <p><strong>注：</strong>若你使用springboot配套的spring-data-redis，需要注意依赖的版本问题。关于如何查看项目依赖，请参考<a href="../tool/maven-dependency#spring-boot%E4%BD%8E%E7%89%88%E6%9C%AC%E5%8D%87%E7%BA%A7jedis%E8%87%B3360%E7%89%88%E6%9C%AC">spring-boot低版本升级jedis至3.6.0版本</a></p> </li> <li> <p>源码修改编译 拉取Jedis源码包，修改Pool的构造方法，使其支持Abandon Config设置，重新编译，生成定制版的jar。</p> <blockquote> <p>优点：可自定义程度高，甚至可以将原先仅支持几个配置的pool，完全置于配置文件中；同时其他的操作都可以共享该配置。</p> <p>缺点：每次redis升级都得适配</p> </blockquote> <p>参考<a href="https://github.com/redis/jedis/compare/master...venukbh:jedis:jedis-pool-with-abandon-config">redis-abandon-config</a></p> </li> <li> <p>重写connection方法 仅修改CachaAspectSupport相关，通过自定义实现RedisCacheWriter，重写其connection()方法</p> <blockquote> <p>优点：不影响源码包，后续升级不受影响</p> <p>缺点：代码显得冗余，容易造成使用误解或干扰，重新执行了一次创建pool的流程，且redis其他使用pool的地方仍旧使用原先的pool，可以理解为维护了两套pool</p> </blockquote> <div class="language-java highlighter-rouge notranslate">
<div class="highlight">
<pre class="highlight"><code>   <span class="kn">package</span> <span class="nn">com.kaizhi.cache</span><span class="o">;</span>
      
   <span class="kn">import</span> <span class="nn">com.kaizhi.scheduling.config.JedisSelfFactory</span><span class="o">;</span>
   <span class="kn">import</span> <span class="nn">lombok.extern.slf4j.Slf4j</span><span class="o">;</span>
      
   <span class="kn">import</span> <span class="nn">org.apache.commons.pool2.impl.AbandonedConfig</span><span class="o">;</span>
   <span class="kn">import</span> <span class="nn">org.apache.commons.pool2.impl.GenericObjectPool</span><span class="o">;</span>
   <span class="kn">import</span> <span class="nn">org.apache.commons.pool2.impl.GenericObjectPoolConfig</span><span class="o">;</span>
   <span class="kn">import</span> <span class="nn">org.springframework.dao.PessimisticLockingFailureException</span><span class="o">;</span>
   <span class="kn">import</span> <span class="nn">org.springframework.data.redis.cache.RedisCacheWriter</span><span class="o">;</span>
   <span class="kn">import</span> <span class="nn">org.springframework.data.redis.connection.RedisConnection</span><span class="o">;</span>
   <span class="kn">import</span> <span class="nn">org.springframework.data.redis.connection.RedisConnectionFactory</span><span class="o">;</span>
   <span class="kn">import</span> <span class="nn">org.springframework.data.redis.connection.RedisStringCommands</span><span class="o">;</span>
   <span class="kn">import</span> <span class="nn">org.springframework.data.redis.connection.jedis.JedisClientConfiguration</span><span class="o">;</span>
   <span class="kn">import</span> <span class="nn">org.springframework.data.redis.connection.jedis.JedisConnection</span><span class="o">;</span>
   <span class="kn">import</span> <span class="nn">org.springframework.data.redis.connection.jedis.JedisConnectionFactory</span><span class="o">;</span>
   <span class="kn">import</span> <span class="nn">org.springframework.data.redis.core.types.Expiration</span><span class="o">;</span>
   <span class="kn">import</span> <span class="nn">org.springframework.lang.Nullable</span><span class="o">;</span>
   <span class="kn">import</span> <span class="nn">org.springframework.util.Assert</span><span class="o">;</span>
   <span class="kn">import</span> <span class="nn">redis.clients.jedis.Jedis</span><span class="o">;</span>
   <span class="kn">import</span> <span class="nn">redis.clients.jedis.JedisPool</span><span class="o">;</span>
   <span class="kn">import</span> <span class="nn">redis.clients.jedis.Protocol</span><span class="o">;</span>
   <span class="kn">import</span> <span class="nn">redis.clients.jedis.exceptions.JedisConnectionException</span><span class="o">;</span>
   <span class="kn">import</span> <span class="nn">redis.clients.jedis.exceptions.JedisException</span><span class="o">;</span>
   <span class="kn">import</span> <span class="nn">redis.clients.util.Pool</span><span class="o">;</span>
      
   <span class="kn">import</span> <span class="nn">java.nio.charset.StandardCharsets</span><span class="o">;</span>
   <span class="kn">import</span> <span class="nn">java.time.Duration</span><span class="o">;</span>
   <span class="kn">import</span> <span class="nn">java.util.Collections</span><span class="o">;</span>
   <span class="kn">import</span> <span class="nn">java.util.NoSuchElementException</span><span class="o">;</span>
   <span class="kn">import</span> <span class="nn">java.util.Optional</span><span class="o">;</span>
   <span class="kn">import</span> <span class="nn">java.util.concurrent.TimeUnit</span><span class="o">;</span>
   <span class="kn">import</span> <span class="nn">java.util.function.Consumer</span><span class="o">;</span>
   <span class="kn">import</span> <span class="nn">java.util.function.Function</span><span class="o">;</span>
      
   <span class="cm">/**
    * @Author: youzhanghao
    * @ClassName: IRedisCacheWriter
    * @Date: 2022-11-29 10:01:14
    * @email: m13732916591_1@163.com
    * @Description: 
    * @Version: 1.0
    */</span>
   <span class="nd">@Slf4j</span>
   <span class="kd">public</span> <span class="kd">class</span> <span class="nc">IRedisCacheWriter</span> <span class="kd">implements</span> <span class="nc">RedisCacheWriter</span> <span class="o">{</span>
      
       <span class="kd">private</span> <span class="kd">final</span> <span class="nc">RedisConnectionFactory</span> <span class="n">connectionFactory</span><span class="o">;</span>
       <span class="kd">private</span> <span class="kd">final</span> <span class="nc">Duration</span> <span class="n">sleepTime</span><span class="o">;</span>
      
      
       <span class="cm">/**
        * @param connectionFactory must not be {@literal null}.
        */</span>
       <span class="kd">public</span> <span class="nf">IRedisCacheWriter</span> <span class="o">(</span><span class="nc">RedisConnectionFactory</span> <span class="n">connectionFactory</span><span class="o">)</span> <span class="o">{</span>
           <span class="k">this</span><span class="o">(</span><span class="n">connectionFactory</span><span class="o">,</span> <span class="nc">Duration</span><span class="o">.</span><span class="na">ZERO</span><span class="o">);</span>
       <span class="o">}</span>
      
       <span class="kd">public</span> <span class="nf">IRedisCacheWriter</span> <span class="o">(</span><span class="nc">JedisConnectionFactory</span> <span class="n">connectionFactory</span><span class="o">)</span> <span class="o">{</span>
           <span class="k">this</span><span class="o">(</span><span class="n">connectionFactory</span><span class="o">,</span> <span class="nc">Duration</span><span class="o">.</span><span class="na">ZERO</span><span class="o">);</span>
       <span class="o">}</span>
      
       <span class="cm">/**
        * @param connectionFactory must not be {@literal null}.
        * @param sleepTime sleep time between lock request attempts. Must not be {@literal null}. Use {@link Duration#ZERO}
        *          to disable locking.
        */</span>
       <span class="kd">public</span> <span class="nf">IRedisCacheWriter</span> <span class="o">(</span><span class="nc">RedisConnectionFactory</span> <span class="n">connectionFactory</span><span class="o">,</span> <span class="nc">Duration</span> <span class="n">sleepTime</span><span class="o">)</span> <span class="o">{</span>
      
           <span class="nc">Assert</span><span class="o">.</span><span class="na">notNull</span><span class="o">(</span><span class="n">connectionFactory</span><span class="o">,</span> <span class="s">"ConnectionFactory must not be null!"</span><span class="o">);</span>
           <span class="nc">Assert</span><span class="o">.</span><span class="na">notNull</span><span class="o">(</span><span class="n">sleepTime</span><span class="o">,</span> <span class="s">"SleepTime must not be null!"</span><span class="o">);</span>
      
           <span class="k">this</span><span class="o">.</span><span class="na">connectionFactory</span> <span class="o">=</span> <span class="n">connectionFactory</span><span class="o">;</span>
           <span class="k">this</span><span class="o">.</span><span class="na">sleepTime</span> <span class="o">=</span> <span class="n">sleepTime</span><span class="o">;</span>
       <span class="o">}</span>
      
       <span class="cm">/*
        * (non-Javadoc)
        * @see org.springframework.data.redis.cache.RedisCacheWriter#put(java.lang.String, byte[], byte[], java.time.Duration)
        */</span>
       <span class="nd">@Override</span>
       <span class="kd">public</span> <span class="kt">void</span> <span class="nf">put</span><span class="o">(</span><span class="nc">String</span> <span class="n">name</span><span class="o">,</span> <span class="kt">byte</span><span class="o">[]</span> <span class="n">key</span><span class="o">,</span> <span class="kt">byte</span><span class="o">[]</span> <span class="n">value</span><span class="o">,</span> <span class="nd">@Nullable</span> <span class="nc">Duration</span> <span class="n">ttl</span><span class="o">)</span> <span class="o">{</span>
      
           <span class="nc">Assert</span><span class="o">.</span><span class="na">notNull</span><span class="o">(</span><span class="n">name</span><span class="o">,</span> <span class="s">"Name must not be null!"</span><span class="o">);</span>
           <span class="nc">Assert</span><span class="o">.</span><span class="na">notNull</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="s">"Key must not be null!"</span><span class="o">);</span>
           <span class="nc">Assert</span><span class="o">.</span><span class="na">notNull</span><span class="o">(</span><span class="n">value</span><span class="o">,</span> <span class="s">"Value must not be null!"</span><span class="o">);</span>
      
           <span class="n">execute</span><span class="o">(</span><span class="n">name</span><span class="o">,</span> <span class="n">connection</span> <span class="o">-&gt;</span> <span class="o">{</span>
      
               <span class="k">if</span> <span class="o">(</span><span class="n">shouldExpireWithin</span><span class="o">(</span><span class="n">ttl</span><span class="o">))</span> <span class="o">{</span>
                   <span class="n">connection</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="n">value</span><span class="o">,</span> <span class="nc">Expiration</span><span class="o">.</span><span class="na">from</span><span class="o">(</span><span class="n">ttl</span><span class="o">.</span><span class="na">toMillis</span><span class="o">(),</span> <span class="nc">TimeUnit</span><span class="o">.</span><span class="na">MILLISECONDS</span><span class="o">),</span> <span class="nc">RedisStringCommands</span><span class="o">.</span><span class="na">SetOption</span><span class="o">.</span><span class="na">upsert</span><span class="o">());</span>
               <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                   <span class="n">connection</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="n">value</span><span class="o">);</span>
               <span class="o">}</span>
      
               <span class="k">return</span> <span class="s">"OK"</span><span class="o">;</span>
           <span class="o">});</span>
       <span class="o">}</span>
      
       <span class="cm">/*
        * (non-Javadoc)
        * @see org.springframework.data.redis.cache.RedisCacheWriter#get(java.lang.String, byte[])
        */</span>
       <span class="nd">@Override</span>
       <span class="kd">public</span> <span class="kt">byte</span><span class="o">[]</span> <span class="nf">get</span><span class="o">(</span><span class="nc">String</span> <span class="n">name</span><span class="o">,</span> <span class="kt">byte</span><span class="o">[]</span> <span class="n">key</span><span class="o">)</span> <span class="o">{</span>
      
           <span class="nc">Assert</span><span class="o">.</span><span class="na">notNull</span><span class="o">(</span><span class="n">name</span><span class="o">,</span> <span class="s">"Name must not be null!"</span><span class="o">);</span>
           <span class="nc">Assert</span><span class="o">.</span><span class="na">notNull</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="s">"Key must not be null!"</span><span class="o">);</span>
      
           <span class="k">return</span> <span class="nf">execute</span><span class="o">(</span><span class="n">name</span><span class="o">,</span> <span class="n">connection</span> <span class="o">-&gt;</span> <span class="n">connection</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">key</span><span class="o">));</span>
       <span class="o">}</span>
      
       <span class="cm">/*
        * (non-Javadoc)
        * @see org.springframework.data.redis.cache.RedisCacheWriter#putIfAbsent(java.lang.String, byte[], byte[], java.time.Duration)
        */</span>
       <span class="nd">@Override</span>
       <span class="kd">public</span> <span class="kt">byte</span><span class="o">[]</span> <span class="nf">putIfAbsent</span><span class="o">(</span><span class="nc">String</span> <span class="n">name</span><span class="o">,</span> <span class="kt">byte</span><span class="o">[]</span> <span class="n">key</span><span class="o">,</span> <span class="kt">byte</span><span class="o">[]</span> <span class="n">value</span><span class="o">,</span> <span class="nd">@Nullable</span> <span class="nc">Duration</span> <span class="n">ttl</span><span class="o">)</span> <span class="o">{</span>
      
           <span class="nc">Assert</span><span class="o">.</span><span class="na">notNull</span><span class="o">(</span><span class="n">name</span><span class="o">,</span> <span class="s">"Name must not be null!"</span><span class="o">);</span>
           <span class="nc">Assert</span><span class="o">.</span><span class="na">notNull</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="s">"Key must not be null!"</span><span class="o">);</span>
           <span class="nc">Assert</span><span class="o">.</span><span class="na">notNull</span><span class="o">(</span><span class="n">value</span><span class="o">,</span> <span class="s">"Value must not be null!"</span><span class="o">);</span>
      
           <span class="k">return</span> <span class="nf">execute</span><span class="o">(</span><span class="n">name</span><span class="o">,</span> <span class="n">connection</span> <span class="o">-&gt;</span> <span class="o">{</span>
      
               <span class="k">if</span> <span class="o">(</span><span class="n">isLockingCacheWriter</span><span class="o">())</span> <span class="o">{</span>
                   <span class="n">doLock</span><span class="o">(</span><span class="n">name</span><span class="o">,</span> <span class="n">connection</span><span class="o">);</span>
               <span class="o">}</span>
      
               <span class="k">try</span> <span class="o">{</span>
                   <span class="k">if</span> <span class="o">(</span><span class="n">connection</span><span class="o">.</span><span class="na">setNX</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="n">value</span><span class="o">))</span> <span class="o">{</span>
      
                       <span class="k">if</span> <span class="o">(</span><span class="n">shouldExpireWithin</span><span class="o">(</span><span class="n">ttl</span><span class="o">))</span> <span class="o">{</span>
                           <span class="n">connection</span><span class="o">.</span><span class="na">pExpire</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="n">ttl</span><span class="o">.</span><span class="na">toMillis</span><span class="o">());</span>
                       <span class="o">}</span>
                       <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
                   <span class="o">}</span>
      
                   <span class="k">return</span> <span class="n">connection</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">key</span><span class="o">);</span>
               <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
      
                   <span class="k">if</span> <span class="o">(</span><span class="n">isLockingCacheWriter</span><span class="o">())</span> <span class="o">{</span>
                       <span class="n">doUnlock</span><span class="o">(</span><span class="n">name</span><span class="o">,</span> <span class="n">connection</span><span class="o">);</span>
                   <span class="o">}</span>
               <span class="o">}</span>
           <span class="o">});</span>
       <span class="o">}</span>
      
       <span class="cm">/*
        * (non-Javadoc)
        * @see org.springframework.data.redis.cache.RedisCacheWriter#remove(java.lang.String, byte[])
        */</span>
       <span class="nd">@Override</span>
       <span class="kd">public</span> <span class="kt">void</span> <span class="nf">remove</span><span class="o">(</span><span class="nc">String</span> <span class="n">name</span><span class="o">,</span> <span class="kt">byte</span><span class="o">[]</span> <span class="n">key</span><span class="o">)</span> <span class="o">{</span>
      
           <span class="nc">Assert</span><span class="o">.</span><span class="na">notNull</span><span class="o">(</span><span class="n">name</span><span class="o">,</span> <span class="s">"Name must not be null!"</span><span class="o">);</span>
           <span class="nc">Assert</span><span class="o">.</span><span class="na">notNull</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="s">"Key must not be null!"</span><span class="o">);</span>
      
           <span class="n">execute</span><span class="o">(</span><span class="n">name</span><span class="o">,</span> <span class="n">connection</span> <span class="o">-&gt;</span> <span class="n">connection</span><span class="o">.</span><span class="na">del</span><span class="o">(</span><span class="n">key</span><span class="o">));</span>
       <span class="o">}</span>
      
       <span class="cm">/*
        * (non-Javadoc)
        * @see org.springframework.data.redis.cache.RedisCacheWriter#clean(java.lang.String, byte[])
        */</span>
       <span class="nd">@Override</span>
       <span class="kd">public</span> <span class="kt">void</span> <span class="nf">clean</span><span class="o">(</span><span class="nc">String</span> <span class="n">name</span><span class="o">,</span> <span class="kt">byte</span><span class="o">[]</span> <span class="n">pattern</span><span class="o">)</span> <span class="o">{</span>
      
           <span class="nc">Assert</span><span class="o">.</span><span class="na">notNull</span><span class="o">(</span><span class="n">name</span><span class="o">,</span> <span class="s">"Name must not be null!"</span><span class="o">);</span>
           <span class="nc">Assert</span><span class="o">.</span><span class="na">notNull</span><span class="o">(</span><span class="n">pattern</span><span class="o">,</span> <span class="s">"Pattern must not be null!"</span><span class="o">);</span>
      
           <span class="n">execute</span><span class="o">(</span><span class="n">name</span><span class="o">,</span> <span class="n">connection</span> <span class="o">-&gt;</span> <span class="o">{</span>
      
               <span class="kt">boolean</span> <span class="n">wasLocked</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
      
               <span class="k">try</span> <span class="o">{</span>
      
                   <span class="k">if</span> <span class="o">(</span><span class="n">isLockingCacheWriter</span><span class="o">())</span> <span class="o">{</span>
                       <span class="n">doLock</span><span class="o">(</span><span class="n">name</span><span class="o">,</span> <span class="n">connection</span><span class="o">);</span>
                       <span class="n">wasLocked</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
                   <span class="o">}</span>
      
                   <span class="c1">//使用scan命令代替keys命令</span>
                   <span class="nc">Cursor</span><span class="o">&lt;</span><span class="kt">byte</span><span class="o">[]&gt;</span> <span class="n">cursor</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="na">scan</span><span class="o">(</span><span class="k">new</span> <span class="nc">ScanOptions</span><span class="o">.</span><span class="na">ScanOptionsBuilder</span><span class="o">().</span><span class="na">match</span><span class="o">(</span><span class="k">new</span> <span class="nc">String</span><span class="o">(</span><span class="n">pattern</span><span class="o">)).</span><span class="na">count</span><span class="o">(</span><span class="mi">1000</span><span class="o">).</span><span class="na">build</span><span class="o">());</span>
                   <span class="nc">Set</span><span class="o">&lt;</span><span class="kt">byte</span><span class="o">[]&gt;</span> <span class="n">byteSet</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashSet</span><span class="o">&lt;&gt;();</span>
                   <span class="k">while</span> <span class="o">(</span><span class="n">cursor</span><span class="o">.</span><span class="na">hasNext</span><span class="o">())</span> <span class="o">{</span>
                       <span class="n">byteSet</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">cursor</span><span class="o">.</span><span class="na">next</span><span class="o">());</span>
                   <span class="o">}</span>
      
                   <span class="kt">byte</span><span class="o">[][]</span> <span class="n">keys</span> <span class="o">=</span> <span class="n">byteSet</span><span class="o">.</span><span class="na">toArray</span><span class="o">(</span><span class="k">new</span> <span class="kt">byte</span><span class="o">[</span><span class="mi">0</span><span class="o">][]);</span>
      
                   <span class="k">if</span> <span class="o">(</span><span class="n">keys</span><span class="o">.</span><span class="na">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
                       <span class="n">connection</span><span class="o">.</span><span class="na">del</span><span class="o">(</span><span class="n">keys</span><span class="o">);</span>
                   <span class="o">}</span>
               <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
      
                   <span class="k">if</span> <span class="o">(</span><span class="n">wasLocked</span> <span class="o">&amp;&amp;</span> <span class="n">isLockingCacheWriter</span><span class="o">())</span> <span class="o">{</span>
                       <span class="n">doUnlock</span><span class="o">(</span><span class="n">name</span><span class="o">,</span> <span class="n">connection</span><span class="o">);</span>
                   <span class="o">}</span>
               <span class="o">}</span>
      
               <span class="k">return</span> <span class="s">"OK"</span><span class="o">;</span>
           <span class="o">});</span>
       <span class="o">}</span>
      
      
      
       <span class="cm">/**
        * Explicitly set a write lock on a cache.
        *
        * @param name the name of the cache to lock.
        */</span>
       <span class="kt">void</span> <span class="nf">lock</span><span class="o">(</span><span class="nc">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span>
           <span class="n">execute</span><span class="o">(</span><span class="n">name</span><span class="o">,</span> <span class="n">connection</span> <span class="o">-&gt;</span> <span class="n">doLock</span><span class="o">(</span><span class="n">name</span><span class="o">,</span> <span class="n">connection</span><span class="o">));</span>
       <span class="o">}</span>
      
       <span class="cm">/**
        * Explicitly remove a write lock from a cache.
        *
        * @param name the name of the cache to unlock.
        */</span>
       <span class="kt">void</span> <span class="nf">unlock</span><span class="o">(</span><span class="nc">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span>
           <span class="n">executeLockFree</span><span class="o">(</span><span class="n">connection</span> <span class="o">-&gt;</span> <span class="n">doUnlock</span><span class="o">(</span><span class="n">name</span><span class="o">,</span> <span class="n">connection</span><span class="o">));</span>
       <span class="o">}</span>
      
       <span class="kd">private</span> <span class="nc">Boolean</span> <span class="nf">doLock</span><span class="o">(</span><span class="nc">String</span> <span class="n">name</span><span class="o">,</span> <span class="nc">RedisConnection</span> <span class="n">connection</span><span class="o">)</span> <span class="o">{</span>
           <span class="k">return</span> <span class="n">connection</span><span class="o">.</span><span class="na">setNX</span><span class="o">(</span><span class="n">createCacheLockKey</span><span class="o">(</span><span class="n">name</span><span class="o">),</span> <span class="k">new</span> <span class="kt">byte</span><span class="o">[</span><span class="mi">0</span><span class="o">]);</span>
       <span class="o">}</span>
      
       <span class="kd">private</span> <span class="nc">Long</span> <span class="nf">doUnlock</span><span class="o">(</span><span class="nc">String</span> <span class="n">name</span><span class="o">,</span> <span class="nc">RedisConnection</span> <span class="n">connection</span><span class="o">)</span> <span class="o">{</span>
           <span class="k">return</span> <span class="n">connection</span><span class="o">.</span><span class="na">del</span><span class="o">(</span><span class="n">createCacheLockKey</span><span class="o">(</span><span class="n">name</span><span class="o">));</span>
       <span class="o">}</span>
      
       <span class="kt">boolean</span> <span class="nf">doCheckLock</span><span class="o">(</span><span class="nc">String</span> <span class="n">name</span><span class="o">,</span> <span class="nc">RedisConnection</span> <span class="n">connection</span><span class="o">)</span> <span class="o">{</span>
           <span class="k">return</span> <span class="n">connection</span><span class="o">.</span><span class="na">exists</span><span class="o">(</span><span class="n">createCacheLockKey</span><span class="o">(</span><span class="n">name</span><span class="o">));</span>
       <span class="o">}</span>
      
       <span class="cm">/**
        * @return {@literal true} if {@link RedisCacheWriter} uses locks.
        */</span>
       <span class="kd">private</span> <span class="kt">boolean</span> <span class="nf">isLockingCacheWriter</span><span class="o">()</span> <span class="o">{</span>
           <span class="k">return</span> <span class="o">!</span><span class="n">sleepTime</span><span class="o">.</span><span class="na">isZero</span><span class="o">()</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">sleepTime</span><span class="o">.</span><span class="na">isNegative</span><span class="o">();</span>
       <span class="o">}</span>
      
       <span class="kd">private</span> <span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="no">T</span> <span class="nf">execute</span><span class="o">(</span><span class="nc">String</span> <span class="n">name</span><span class="o">,</span> <span class="nc">Function</span><span class="o">&lt;</span><span class="nc">RedisConnection</span><span class="o">,</span> <span class="no">T</span><span class="o">&gt;</span> <span class="n">callback</span><span class="o">)</span> <span class="o">{</span>
           <span class="nc">RedisConnection</span> <span class="n">connection</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
           <span class="k">try</span> <span class="o">{</span>
               <span class="nc">JedisConnectionFactory</span> <span class="n">jedisConnectionFactory</span> <span class="o">=</span> <span class="o">(</span><span class="nc">JedisConnectionFactory</span><span class="o">)</span> <span class="n">connectionFactory</span><span class="o">;</span>
               <span class="n">connection</span> <span class="o">=</span> <span class="n">getConnection</span><span class="o">(</span><span class="n">jedisConnectionFactory</span><span class="o">);</span>
               <span class="c1">// connection = connectionFactory.getConnection();</span>
               <span class="n">checkAndPotentiallyWaitUntilUnlocked</span><span class="o">(</span><span class="n">name</span><span class="o">,</span> <span class="n">connection</span><span class="o">);</span>
               <span class="k">return</span> <span class="n">callback</span><span class="o">.</span><span class="na">apply</span><span class="o">(</span><span class="n">connection</span><span class="o">);</span>
           <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
               <span class="k">if</span><span class="o">(</span><span class="n">connection</span> <span class="o">!=</span><span class="kc">null</span><span class="o">){</span>
                   <span class="n">connection</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
               <span class="o">}</span>
           <span class="o">}</span>
       <span class="o">}</span>
      
       <span class="kd">public</span> <span class="nc">RedisConnection</span> <span class="nf">getConnection</span><span class="o">(</span><span class="nc">JedisConnectionFactory</span> <span class="n">connectionFactory</span><span class="o">)</span> <span class="o">{</span>
      
           <span class="k">if</span> <span class="o">(</span><span class="n">connectionFactory</span><span class="o">.</span><span class="na">isRedisClusterAware</span><span class="o">())</span> <span class="o">{</span>
               <span class="k">return</span> <span class="n">connectionFactory</span><span class="o">.</span><span class="na">getClusterConnection</span><span class="o">();</span>
           <span class="o">}</span>
      
           <span class="nc">GenericObjectPoolConfig</span> <span class="n">poolConfig</span> <span class="o">=</span> <span class="n">connectionFactory</span><span class="o">.</span><span class="na">getPoolConfig</span><span class="o">()</span> <span class="o">;</span>
           <span class="nc">AbandonedConfig</span> <span class="n">abandonedConfig</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">AbandonedConfig</span><span class="o">();</span>
           <span class="n">abandonedConfig</span><span class="o">.</span><span class="na">setLogAbandoned</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
           <span class="n">abandonedConfig</span><span class="o">.</span><span class="na">setRemoveAbandonedOnBorrow</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
           <span class="nc">GenericObjectPool</span><span class="o">&lt;</span><span class="nc">Jedis</span><span class="o">&gt;</span> <span class="n">pool</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">GenericObjectPool</span><span class="o">&lt;</span><span class="nc">Jedis</span><span class="o">&gt;(</span><span class="k">new</span> <span class="nc">JedisSelfFactory</span><span class="o">(</span><span class="n">connectionFactory</span><span class="o">.</span><span class="na">getHostName</span><span class="o">(),</span> <span class="n">connectionFactory</span><span class="o">.</span><span class="na">getPort</span><span class="o">(),</span> <span class="nc">Protocol</span><span class="o">.</span><span class="na">DEFAULT_TIMEOUT</span><span class="o">,</span> <span class="nc">Protocol</span><span class="o">.</span><span class="na">DEFAULT_TIMEOUT</span> <span class="o">,</span>
                   <span class="n">connectionFactory</span><span class="o">.</span><span class="na">getPassword</span><span class="o">(),</span> <span class="n">connectionFactory</span><span class="o">.</span><span class="na">getDatabase</span><span class="o">(),</span> <span class="s">"test"</span><span class="o">,</span> <span class="n">connectionFactory</span><span class="o">.</span><span class="na">isUseSsl</span><span class="o">(),</span> <span class="kc">null</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="kc">null</span><span class="o">),</span> <span class="n">poolConfig</span><span class="o">,</span><span class="n">abandonedConfig</span><span class="o">);</span>
           <span class="nc">Pool</span><span class="o">&lt;</span><span class="nc">Jedis</span><span class="o">&gt;</span> <span class="n">jedisPool</span> <span class="o">=</span> <span class="n">createRedisPool</span><span class="o">(</span><span class="n">connectionFactory</span><span class="o">);</span>
           <span class="nc">Jedis</span> <span class="n">jedis</span><span class="o">;</span>
           <span class="k">try</span> <span class="o">{</span>
               <span class="n">jedis</span> <span class="o">=</span> <span class="n">pool</span><span class="o">.</span><span class="na">borrowObject</span><span class="o">();</span>
           <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">NoSuchElementException</span> <span class="n">nse</span><span class="o">)</span> <span class="o">{</span>
               <span class="k">throw</span> <span class="k">new</span> <span class="nf">JedisException</span><span class="o">(</span><span class="s">"Could not get a resource from the pool"</span><span class="o">,</span> <span class="n">nse</span><span class="o">);</span>
           <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
               <span class="k">throw</span> <span class="k">new</span> <span class="nf">JedisConnectionException</span><span class="o">(</span><span class="s">"Could not get a resource from the pool"</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
           <span class="o">}</span>
           <span class="nc">JedisConnection</span> <span class="n">connection</span> <span class="o">=</span> <span class="o">(</span><span class="n">connectionFactory</span><span class="o">.</span><span class="na">getUsePool</span><span class="o">()</span> <span class="o">?</span> <span class="k">new</span> <span class="nc">JedisConnection</span><span class="o">(</span><span class="n">jedis</span><span class="o">,</span> <span class="n">jedisPool</span><span class="o">,</span> <span class="n">connectionFactory</span><span class="o">.</span><span class="na">getDatabase</span><span class="o">())</span>
                   <span class="o">:</span> <span class="k">new</span> <span class="nc">JedisConnection</span><span class="o">(</span><span class="n">jedis</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="n">connectionFactory</span><span class="o">.</span><span class="na">getDatabase</span><span class="o">()));</span>
           <span class="k">return</span> <span class="n">connection</span><span class="o">;</span>
       <span class="o">}</span>
      
       <span class="kd">protected</span> <span class="nc">Pool</span><span class="o">&lt;</span><span class="nc">Jedis</span><span class="o">&gt;</span> <span class="nf">createRedisPool</span><span class="o">(</span><span class="nc">JedisConnectionFactory</span> <span class="n">jedisConnectionFactory</span><span class="o">)</span> <span class="o">{</span>
           <span class="nc">JedisClientConfiguration</span> <span class="n">clientConfiguration</span> <span class="o">=</span> <span class="n">jedisConnectionFactory</span><span class="o">.</span><span class="na">getClientConfiguration</span><span class="o">();</span>
           <span class="k">return</span> <span class="k">new</span> <span class="nf">JedisPool</span><span class="o">(</span><span class="n">jedisConnectionFactory</span><span class="o">.</span><span class="na">getPoolConfig</span><span class="o">(),</span> <span class="n">jedisConnectionFactory</span><span class="o">.</span><span class="na">getHostName</span><span class="o">(),</span> <span class="n">jedisConnectionFactory</span><span class="o">.</span><span class="na">getPort</span><span class="o">(),</span><span class="n">getConnectTimeout</span><span class="o">(</span><span class="n">clientConfiguration</span><span class="o">),</span> <span class="n">getReadTimeout</span><span class="o">(</span><span class="n">clientConfiguration</span><span class="o">),</span>
                   <span class="n">jedisConnectionFactory</span><span class="o">.</span><span class="na">getPassword</span><span class="o">(),</span><span class="n">jedisConnectionFactory</span><span class="o">.</span><span class="na">getDatabase</span><span class="o">(),</span> <span class="n">jedisConnectionFactory</span><span class="o">.</span><span class="na">getClientName</span><span class="o">(),</span> <span class="n">jedisConnectionFactory</span><span class="o">.</span><span class="na">isUseSsl</span><span class="o">(),</span>
                   <span class="n">clientConfiguration</span><span class="o">.</span><span class="na">getSslSocketFactory</span><span class="o">().</span><span class="na">orElse</span><span class="o">(</span><span class="kc">null</span><span class="o">),</span> <span class="c1">//</span>
                   <span class="n">clientConfiguration</span><span class="o">.</span><span class="na">getSslParameters</span><span class="o">().</span><span class="na">orElse</span><span class="o">(</span><span class="kc">null</span><span class="o">),</span> <span class="c1">//</span>
                   <span class="n">clientConfiguration</span><span class="o">.</span><span class="na">getHostnameVerifier</span><span class="o">().</span><span class="na">orElse</span><span class="o">(</span><span class="kc">null</span><span class="o">));</span>
       <span class="o">}</span>
      
       <span class="kd">private</span> <span class="kt">int</span> <span class="nf">getConnectTimeout</span><span class="o">(</span><span class="nc">JedisClientConfiguration</span> <span class="n">clientConfiguration</span><span class="o">)</span> <span class="o">{</span>
           <span class="k">return</span> <span class="nc">Math</span><span class="o">.</span><span class="na">toIntExact</span><span class="o">(</span><span class="n">clientConfiguration</span><span class="o">.</span><span class="na">getConnectTimeout</span><span class="o">().</span><span class="na">toMillis</span><span class="o">());</span>
       <span class="o">}</span>
      
       <span class="kd">private</span> <span class="kt">int</span> <span class="nf">getReadTimeout</span><span class="o">(</span><span class="nc">JedisClientConfiguration</span> <span class="n">clientConfiguration</span><span class="o">)</span> <span class="o">{</span>
           <span class="k">return</span> <span class="nc">Math</span><span class="o">.</span><span class="na">toIntExact</span><span class="o">(</span><span class="n">clientConfiguration</span><span class="o">.</span><span class="na">getReadTimeout</span><span class="o">().</span><span class="na">toMillis</span><span class="o">());</span>
       <span class="o">}</span>
      
      
      
       <span class="kd">private</span> <span class="kt">void</span> <span class="nf">executeLockFree</span><span class="o">(</span><span class="nc">Consumer</span><span class="o">&lt;</span><span class="nc">RedisConnection</span><span class="o">&gt;</span> <span class="n">callback</span><span class="o">)</span> <span class="o">{</span>
      
           <span class="nc">RedisConnection</span> <span class="n">connection</span> <span class="o">=</span> <span class="n">connectionFactory</span><span class="o">.</span><span class="na">getConnection</span><span class="o">();</span>
      
           <span class="k">try</span> <span class="o">{</span>
               <span class="n">callback</span><span class="o">.</span><span class="na">accept</span><span class="o">(</span><span class="n">connection</span><span class="o">);</span>
           <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
               <span class="n">connection</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
           <span class="o">}</span>
       <span class="o">}</span>
      
       <span class="kd">private</span> <span class="kt">void</span> <span class="nf">checkAndPotentiallyWaitUntilUnlocked</span><span class="o">(</span><span class="nc">String</span> <span class="n">name</span><span class="o">,</span> <span class="nc">RedisConnection</span> <span class="n">connection</span><span class="o">)</span> <span class="o">{</span>
      
           <span class="k">if</span> <span class="o">(!</span><span class="n">isLockingCacheWriter</span><span class="o">())</span> <span class="o">{</span>
               <span class="k">return</span><span class="o">;</span>
           <span class="o">}</span>
      
           <span class="k">try</span> <span class="o">{</span>
      
               <span class="k">while</span> <span class="o">(</span><span class="n">doCheckLock</span><span class="o">(</span><span class="n">name</span><span class="o">,</span> <span class="n">connection</span><span class="o">))</span> <span class="o">{</span>
                   <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="n">sleepTime</span><span class="o">.</span><span class="na">toMillis</span><span class="o">());</span>
               <span class="o">}</span>
           <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
      
               <span class="c1">// Re-interrupt current thread, to allow other participants to react.</span>
               <span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">interrupt</span><span class="o">();</span>
      
               <span class="k">throw</span> <span class="k">new</span> <span class="nf">PessimisticLockingFailureException</span><span class="o">(</span><span class="nc">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">"Interrupted while waiting to unlock cache %s"</span><span class="o">,</span> <span class="n">name</span><span class="o">),</span>
                       <span class="n">ex</span><span class="o">);</span>
           <span class="o">}</span>
       <span class="o">}</span>
      
       <span class="kd">private</span> <span class="kd">static</span> <span class="kt">boolean</span> <span class="nf">shouldExpireWithin</span><span class="o">(</span><span class="nd">@Nullable</span> <span class="nc">Duration</span> <span class="n">ttl</span><span class="o">)</span> <span class="o">{</span>
           <span class="k">return</span> <span class="n">ttl</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">ttl</span><span class="o">.</span><span class="na">isZero</span><span class="o">()</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">ttl</span><span class="o">.</span><span class="na">isNegative</span><span class="o">();</span>
       <span class="o">}</span>
      
       <span class="kd">private</span> <span class="kd">static</span> <span class="kt">byte</span><span class="o">[]</span> <span class="nf">createCacheLockKey</span><span class="o">(</span><span class="nc">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span>
           <span class="k">return</span> <span class="o">(</span><span class="n">name</span> <span class="o">+</span> <span class="s">"~lock"</span><span class="o">).</span><span class="na">getBytes</span><span class="o">(</span><span class="nc">StandardCharsets</span><span class="o">.</span><span class="na">UTF_8</span><span class="o">);</span>
       <span class="o">}</span>
      
      
   <span class="o">}</span>
      
</code></pre>  </div> </div> <div class="language-java highlighter-rouge notranslate">
<div class="highlight">
<pre class="highlight"><code>   <span class="kd">public</span> <span class="kd">class</span> <span class="nc">JedisSelfFactory</span>  <span class="kd">implements</span> <span class="nc">PooledObjectFactory</span><span class="o">&lt;</span><span class="nc">Jedis</span><span class="o">&gt;</span> <span class="o">{</span>
       <span class="kd">private</span> <span class="kd">final</span> <span class="nc">AtomicReference</span><span class="o">&lt;</span><span class="nc">HostAndPort</span><span class="o">&gt;</span> <span class="n">hostAndPort</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">AtomicReference</span><span class="o">&lt;</span><span class="nc">HostAndPort</span><span class="o">&gt;();</span>
       <span class="kd">private</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">connectionTimeout</span><span class="o">;</span>
       <span class="kd">private</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">soTimeout</span><span class="o">;</span>
       <span class="kd">private</span> <span class="kd">final</span> <span class="nc">String</span> <span class="n">password</span><span class="o">;</span>
       <span class="kd">private</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">database</span><span class="o">;</span>
       <span class="kd">private</span> <span class="kd">final</span> <span class="nc">String</span> <span class="n">clientName</span><span class="o">;</span>
       <span class="kd">private</span> <span class="kd">final</span> <span class="kt">boolean</span> <span class="n">ssl</span><span class="o">;</span>
       <span class="kd">private</span> <span class="kd">final</span> <span class="nc">SSLSocketFactory</span> <span class="n">sslSocketFactory</span><span class="o">;</span>
       <span class="kd">private</span> <span class="nc">SSLParameters</span> <span class="n">sslParameters</span><span class="o">;</span>
       <span class="kd">private</span> <span class="nc">HostnameVerifier</span> <span class="n">hostnameVerifier</span><span class="o">;</span>
      
       <span class="kd">public</span> <span class="nf">JedisSelfFactory</span><span class="o">(</span><span class="kd">final</span> <span class="nc">String</span> <span class="n">host</span><span class="o">,</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">port</span><span class="o">,</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">connectionTimeout</span><span class="o">,</span>
                           <span class="kd">final</span> <span class="kt">int</span> <span class="n">soTimeout</span><span class="o">,</span> <span class="kd">final</span> <span class="nc">String</span> <span class="n">password</span><span class="o">,</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">database</span><span class="o">,</span> <span class="kd">final</span> <span class="nc">String</span> <span class="n">clientName</span><span class="o">,</span>
                           <span class="kd">final</span> <span class="kt">boolean</span> <span class="n">ssl</span><span class="o">,</span> <span class="kd">final</span> <span class="nc">SSLSocketFactory</span> <span class="n">sslSocketFactory</span><span class="o">,</span> <span class="kd">final</span> <span class="nc">SSLParameters</span> <span class="n">sslParameters</span><span class="o">,</span>
                           <span class="kd">final</span> <span class="nc">HostnameVerifier</span> <span class="n">hostnameVerifier</span><span class="o">)</span> <span class="o">{</span>
           <span class="k">this</span><span class="o">.</span><span class="na">hostAndPort</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="k">new</span> <span class="nc">HostAndPort</span><span class="o">(</span><span class="n">host</span><span class="o">,</span> <span class="n">port</span><span class="o">));</span>
           <span class="k">this</span><span class="o">.</span><span class="na">connectionTimeout</span> <span class="o">=</span> <span class="n">connectionTimeout</span><span class="o">;</span>
           <span class="k">this</span><span class="o">.</span><span class="na">soTimeout</span> <span class="o">=</span> <span class="n">soTimeout</span><span class="o">;</span>
           <span class="k">this</span><span class="o">.</span><span class="na">password</span> <span class="o">=</span> <span class="n">password</span><span class="o">;</span>
           <span class="k">this</span><span class="o">.</span><span class="na">database</span> <span class="o">=</span> <span class="n">database</span><span class="o">;</span>
           <span class="k">this</span><span class="o">.</span><span class="na">clientName</span> <span class="o">=</span> <span class="n">clientName</span><span class="o">;</span>
           <span class="k">this</span><span class="o">.</span><span class="na">ssl</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">;</span>
           <span class="k">this</span><span class="o">.</span><span class="na">sslSocketFactory</span> <span class="o">=</span> <span class="n">sslSocketFactory</span><span class="o">;</span>
           <span class="k">this</span><span class="o">.</span><span class="na">sslParameters</span> <span class="o">=</span> <span class="n">sslParameters</span><span class="o">;</span>
           <span class="k">this</span><span class="o">.</span><span class="na">hostnameVerifier</span> <span class="o">=</span> <span class="n">hostnameVerifier</span><span class="o">;</span>
       <span class="o">}</span>
      
       <span class="kd">public</span> <span class="nf">JedisSelfFactory</span><span class="o">(</span><span class="kd">final</span> <span class="no">URI</span> <span class="n">uri</span><span class="o">,</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">connectionTimeout</span><span class="o">,</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">soTimeout</span><span class="o">,</span>
                           <span class="kd">final</span> <span class="nc">String</span> <span class="n">clientName</span><span class="o">,</span> <span class="kd">final</span> <span class="kt">boolean</span> <span class="n">ssl</span><span class="o">,</span> <span class="kd">final</span> <span class="nc">SSLSocketFactory</span> <span class="n">sslSocketFactory</span><span class="o">,</span>
                           <span class="kd">final</span> <span class="nc">SSLParameters</span> <span class="n">sslParameters</span><span class="o">,</span> <span class="kd">final</span> <span class="nc">HostnameVerifier</span> <span class="n">hostnameVerifier</span><span class="o">)</span> <span class="o">{</span>
           <span class="k">if</span> <span class="o">(!</span><span class="nc">JedisURIHelper</span><span class="o">.</span><span class="na">isValid</span><span class="o">(</span><span class="n">uri</span><span class="o">))</span> <span class="o">{</span>
               <span class="k">throw</span> <span class="k">new</span> <span class="nf">InvalidURIException</span><span class="o">(</span><span class="nc">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span>
                       <span class="s">"Cannot open Redis connection due invalid URI. %s"</span><span class="o">,</span> <span class="n">uri</span><span class="o">.</span><span class="na">toString</span><span class="o">()));</span>
           <span class="o">}</span>
      
           <span class="k">this</span><span class="o">.</span><span class="na">hostAndPort</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="k">new</span> <span class="nc">HostAndPort</span><span class="o">(</span><span class="n">uri</span><span class="o">.</span><span class="na">getHost</span><span class="o">(),</span> <span class="n">uri</span><span class="o">.</span><span class="na">getPort</span><span class="o">()));</span>
           <span class="k">this</span><span class="o">.</span><span class="na">connectionTimeout</span> <span class="o">=</span> <span class="n">connectionTimeout</span><span class="o">;</span>
           <span class="k">this</span><span class="o">.</span><span class="na">soTimeout</span> <span class="o">=</span> <span class="n">soTimeout</span><span class="o">;</span>
           <span class="k">this</span><span class="o">.</span><span class="na">password</span> <span class="o">=</span> <span class="nc">JedisURIHelper</span><span class="o">.</span><span class="na">getPassword</span><span class="o">(</span><span class="n">uri</span><span class="o">);</span>
           <span class="k">this</span><span class="o">.</span><span class="na">database</span> <span class="o">=</span> <span class="nc">JedisURIHelper</span><span class="o">.</span><span class="na">getDBIndex</span><span class="o">(</span><span class="n">uri</span><span class="o">);</span>
           <span class="k">this</span><span class="o">.</span><span class="na">clientName</span> <span class="o">=</span> <span class="n">clientName</span><span class="o">;</span>
           <span class="k">this</span><span class="o">.</span><span class="na">ssl</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">;</span>
           <span class="k">this</span><span class="o">.</span><span class="na">sslSocketFactory</span> <span class="o">=</span> <span class="n">sslSocketFactory</span><span class="o">;</span>
           <span class="k">this</span><span class="o">.</span><span class="na">sslParameters</span> <span class="o">=</span> <span class="n">sslParameters</span><span class="o">;</span>
           <span class="k">this</span><span class="o">.</span><span class="na">hostnameVerifier</span> <span class="o">=</span> <span class="n">hostnameVerifier</span><span class="o">;</span>
       <span class="o">}</span>
      
       <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setHostAndPort</span><span class="o">(</span><span class="kd">final</span> <span class="nc">HostAndPort</span> <span class="n">hostAndPort</span><span class="o">)</span> <span class="o">{</span>
           <span class="k">this</span><span class="o">.</span><span class="na">hostAndPort</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">hostAndPort</span><span class="o">);</span>
       <span class="o">}</span>
      
       <span class="nd">@Override</span>
       <span class="kd">public</span> <span class="kt">void</span> <span class="nf">activateObject</span><span class="o">(</span><span class="nc">PooledObject</span><span class="o">&lt;</span><span class="nc">Jedis</span><span class="o">&gt;</span> <span class="n">pooledJedis</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
           <span class="kd">final</span> <span class="nc">BinaryJedis</span> <span class="n">jedis</span> <span class="o">=</span> <span class="n">pooledJedis</span><span class="o">.</span><span class="na">getObject</span><span class="o">();</span>
           <span class="k">if</span> <span class="o">(</span><span class="n">jedis</span><span class="o">.</span><span class="na">getDB</span><span class="o">()</span> <span class="o">!=</span> <span class="n">database</span><span class="o">)</span> <span class="o">{</span>
               <span class="n">jedis</span><span class="o">.</span><span class="na">select</span><span class="o">(</span><span class="n">database</span><span class="o">);</span>
           <span class="o">}</span>
      
       <span class="o">}</span>
      
       <span class="nd">@Override</span>
       <span class="kd">public</span> <span class="kt">void</span> <span class="nf">destroyObject</span><span class="o">(</span><span class="nc">PooledObject</span><span class="o">&lt;</span><span class="nc">Jedis</span><span class="o">&gt;</span> <span class="n">pooledJedis</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
           <span class="kd">final</span> <span class="nc">BinaryJedis</span> <span class="n">jedis</span> <span class="o">=</span> <span class="n">pooledJedis</span><span class="o">.</span><span class="na">getObject</span><span class="o">();</span>
           <span class="k">if</span> <span class="o">(</span><span class="n">jedis</span><span class="o">.</span><span class="na">isConnected</span><span class="o">())</span> <span class="o">{</span>
               <span class="k">try</span> <span class="o">{</span>
                   <span class="k">try</span> <span class="o">{</span>
                       <span class="n">jedis</span><span class="o">.</span><span class="na">quit</span><span class="o">();</span>
                   <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                   <span class="o">}</span>
                   <span class="n">jedis</span><span class="o">.</span><span class="na">disconnect</span><span class="o">();</span>
               <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
      
               <span class="o">}</span>
           <span class="o">}</span>
      
       <span class="o">}</span>
      
       <span class="nd">@Override</span>
       <span class="kd">public</span> <span class="nc">PooledObject</span><span class="o">&lt;</span><span class="nc">Jedis</span><span class="o">&gt;</span> <span class="nf">makeObject</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
           <span class="kd">final</span> <span class="nc">HostAndPort</span> <span class="n">hostAndPort</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">hostAndPort</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
           <span class="kd">final</span> <span class="nc">Jedis</span> <span class="n">jedis</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Jedis</span><span class="o">(</span><span class="n">hostAndPort</span><span class="o">.</span><span class="na">getHost</span><span class="o">(),</span> <span class="n">hostAndPort</span><span class="o">.</span><span class="na">getPort</span><span class="o">(),</span> <span class="n">connectionTimeout</span><span class="o">,</span>
                   <span class="n">soTimeout</span><span class="o">,</span> <span class="n">ssl</span><span class="o">,</span> <span class="n">sslSocketFactory</span><span class="o">,</span> <span class="n">sslParameters</span><span class="o">,</span> <span class="n">hostnameVerifier</span><span class="o">);</span>
      
           <span class="k">try</span> <span class="o">{</span>
               <span class="n">jedis</span><span class="o">.</span><span class="na">connect</span><span class="o">();</span>
               <span class="k">if</span> <span class="o">(</span><span class="n">password</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                   <span class="n">jedis</span><span class="o">.</span><span class="na">auth</span><span class="o">(</span><span class="n">password</span><span class="o">);</span>
               <span class="o">}</span>
               <span class="k">if</span> <span class="o">(</span><span class="n">database</span> <span class="o">!=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
                   <span class="n">jedis</span><span class="o">.</span><span class="na">select</span><span class="o">(</span><span class="n">database</span><span class="o">);</span>
               <span class="o">}</span>
               <span class="k">if</span> <span class="o">(</span><span class="n">clientName</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                   <span class="n">jedis</span><span class="o">.</span><span class="na">clientSetname</span><span class="o">(</span><span class="n">clientName</span><span class="o">);</span>
               <span class="o">}</span>
           <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">JedisException</span> <span class="n">je</span><span class="o">)</span> <span class="o">{</span>
               <span class="n">jedis</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
               <span class="k">throw</span> <span class="n">je</span><span class="o">;</span>
           <span class="o">}</span>
      
           <span class="k">return</span> <span class="k">new</span> <span class="nc">DefaultPooledObject</span><span class="o">&lt;</span><span class="nc">Jedis</span><span class="o">&gt;(</span><span class="n">jedis</span><span class="o">);</span>
      
       <span class="o">}</span>
      
       <span class="nd">@Override</span>
       <span class="kd">public</span> <span class="kt">void</span> <span class="nf">passivateObject</span><span class="o">(</span><span class="nc">PooledObject</span><span class="o">&lt;</span><span class="nc">Jedis</span><span class="o">&gt;</span> <span class="n">pooledJedis</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
           <span class="c1">// TODO maybe should select db 0? Not sure right now.</span>
       <span class="o">}</span>
      
       <span class="nd">@Override</span>
       <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">validateObject</span><span class="o">(</span><span class="nc">PooledObject</span><span class="o">&lt;</span><span class="nc">Jedis</span><span class="o">&gt;</span> <span class="n">pooledJedis</span><span class="o">)</span> <span class="o">{</span>
           <span class="kd">final</span> <span class="nc">BinaryJedis</span> <span class="n">jedis</span> <span class="o">=</span> <span class="n">pooledJedis</span><span class="o">.</span><span class="na">getObject</span><span class="o">();</span>
           <span class="k">try</span> <span class="o">{</span>
               <span class="nc">HostAndPort</span> <span class="n">hostAndPort</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">hostAndPort</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
      
               <span class="nc">String</span> <span class="n">connectionHost</span> <span class="o">=</span> <span class="n">jedis</span><span class="o">.</span><span class="na">getClient</span><span class="o">().</span><span class="na">getHost</span><span class="o">();</span>
               <span class="kt">int</span> <span class="n">connectionPort</span> <span class="o">=</span> <span class="n">jedis</span><span class="o">.</span><span class="na">getClient</span><span class="o">().</span><span class="na">getPort</span><span class="o">();</span>
      
               <span class="k">return</span> <span class="n">hostAndPort</span><span class="o">.</span><span class="na">getHost</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="n">connectionHost</span><span class="o">)</span>
                       <span class="o">&amp;&amp;</span> <span class="n">hostAndPort</span><span class="o">.</span><span class="na">getPort</span><span class="o">()</span> <span class="o">==</span> <span class="n">connectionPort</span> <span class="o">&amp;&amp;</span> <span class="n">jedis</span><span class="o">.</span><span class="na">isConnected</span><span class="o">()</span>
                       <span class="o">&amp;&amp;</span> <span class="n">jedis</span><span class="o">.</span><span class="na">ping</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="s">"PONG"</span><span class="o">);</span>
           <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="kd">final</span> <span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
               <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
           <span class="o">}</span>
       <span class="o">}</span>
   <span class="o">}</span>
</code></pre>  </div> </div> <div class="language-java highlighter-rouge notranslate">
<div class="highlight">
<pre class="highlight"><code>      
   <span class="nd">@Configuration</span>
   <span class="nd">@EnableCaching</span>
   <span class="kd">public</span> <span class="kd">class</span> <span class="nc">RedisConfig</span> <span class="kd">implements</span> <span class="nc">Serializable</span> <span class="o">{</span>
      
      
      
       <span class="nd">@Bean</span>
       <span class="kd">public</span> <span class="nc">RedisCacheManager</span> <span class="nf">cacheManager</span><span class="o">(</span><span class="nc">RedisConnectionFactory</span> <span class="n">redisConnectionFactory</span><span class="o">)</span> <span class="o">{</span>
           <span class="k">return</span> <span class="k">new</span> <span class="nf">RedisCacheManager</span><span class="o">(</span>
               <span class="k">new</span> <span class="nf">IRedisCacheWriter</span><span class="o">(</span><span class="n">redisConnectionFactory</span><span class="o">),</span>
               <span class="c1">//实时数据 就是默认数据 缓存时间设置</span>
               <span class="k">this</span><span class="o">.</span><span class="na">getRedisCacheConfigurationWithTtl</span><span class="o">(</span><span class="mi">60</span><span class="o">),</span> <span class="c1">// 默认策略，未配置的 key 会使用这个</span>
               <span class="k">this</span><span class="o">.</span><span class="na">getRedisCacheConfigurationMap</span><span class="o">()</span> <span class="c1">// 指定 key 策略</span>
           <span class="o">);</span>
       <span class="o">}</span>
      
       <span class="kd">private</span> <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">RedisCacheConfiguration</span><span class="o">&gt;</span> <span class="nf">getRedisCacheConfigurationMap</span><span class="o">()</span> <span class="o">{</span>
           <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">RedisCacheConfiguration</span><span class="o">&gt;</span> <span class="n">redisCacheConfigurationMap</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashMap</span><span class="o">&lt;&gt;();</span>
           <span class="c1">//历史数据缓存24小时</span>
           <span class="n">redisCacheConfigurationMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"history"</span><span class="o">,</span> <span class="k">this</span><span class="o">.</span><span class="na">getRedisCacheConfigurationWithTtl</span><span class="o">(</span><span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span><span class="o">*</span><span class="mi">23</span><span class="o">));</span>
      
           <span class="k">return</span> <span class="n">redisCacheConfigurationMap</span><span class="o">;</span>
       <span class="o">}</span>
      
       <span class="kd">private</span> <span class="nc">RedisCacheConfiguration</span> <span class="nf">getRedisCacheConfigurationWithTtl</span><span class="o">(</span><span class="nc">Integer</span> <span class="n">seconds</span><span class="o">)</span> <span class="o">{</span>
           <span class="nc">Jackson2JsonRedisSerializer</span><span class="o">&lt;</span><span class="nc">Object</span><span class="o">&gt;</span> <span class="n">jackson2JsonRedisSerializer</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Jackson2JsonRedisSerializer</span><span class="o">&lt;&gt;(</span><span class="nc">Object</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
           <span class="nc">ObjectMapper</span> <span class="n">om</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ObjectMapper</span><span class="o">();</span>
           <span class="n">om</span><span class="o">.</span><span class="na">setVisibility</span><span class="o">(</span><span class="nc">PropertyAccessor</span><span class="o">.</span><span class="na">ALL</span><span class="o">,</span> <span class="nc">JsonAutoDetect</span><span class="o">.</span><span class="na">Visibility</span><span class="o">.</span><span class="na">ANY</span><span class="o">);</span>
           <span class="n">om</span><span class="o">.</span><span class="na">enableDefaultTyping</span><span class="o">(</span><span class="nc">ObjectMapper</span><span class="o">.</span><span class="na">DefaultTyping</span><span class="o">.</span><span class="na">NON_FINAL</span><span class="o">);</span>
           <span class="n">jackson2JsonRedisSerializer</span><span class="o">.</span><span class="na">setObjectMapper</span><span class="o">(</span><span class="n">om</span><span class="o">);</span>
           <span class="nc">RedisCacheConfiguration</span> <span class="n">redisCacheConfiguration</span> <span class="o">=</span> <span class="nc">RedisCacheConfiguration</span><span class="o">.</span><span class="na">defaultCacheConfig</span><span class="o">();</span>
           <span class="n">redisCacheConfiguration</span> <span class="o">=</span> <span class="n">redisCacheConfiguration</span><span class="o">.</span><span class="na">serializeValuesWith</span><span class="o">(</span>
               <span class="nc">RedisSerializationContext</span>
                   <span class="o">.</span><span class="na">SerializationPair</span>
                   <span class="o">.</span><span class="na">fromSerializer</span><span class="o">(</span><span class="n">jackson2JsonRedisSerializer</span><span class="o">)</span>
           <span class="o">).</span><span class="na">entryTtl</span><span class="o">(</span><span class="nc">Duration</span><span class="o">.</span><span class="na">ofSeconds</span><span class="o">(</span><span class="n">seconds</span><span class="o">));</span>
      
           <span class="k">return</span> <span class="n">redisCacheConfiguration</span><span class="o">;</span>
       <span class="o">}</span>
   <span class="o">}</span>
</code></pre>  </div> </div> </li> <li> <p>调整参数；通过源码分析，其是由于在规定时间内未借用到空闲对象，导致异常抛出。 若业务本身不复杂，直接调整max-wait参数</p> <div class="language-yaml highlighter-rouge notranslate">
<div class="highlight">
<pre class="highlight"><code><span class="na">spring</span><span class="pi">:</span>
  <span class="na">redis</span><span class="pi">:</span>
    <span class="na">jedis</span><span class="pi">:</span>
      <span class="na">pool</span><span class="pi">:</span>
        <span class="c1"># 连接池最大阻塞等待时间（使用负值表示没有限制）默认是300ms</span>
        <span class="na">max-wait</span><span class="pi">:</span> <span class="m">300</span>
</code></pre>  </div> </div> </li> </ol> <h2 id="复盘总结">复盘总结</h2> <blockquote> <p>上述的解决方法，后两种核心思想都是设置AbandonConfig，主动释放对象，可能会造成其他正在使用的连接被强制释放，设置需根据具体业务来综合判断。推荐通过升级版本来解决，若实在不能升级版本，可以通过修改jedis.close()方法，参考 <a href="https://hub.nuaa.cf/redis/jedis/pull/1918/commits/df1bffa3c77f4ede4c912f2c3e78b5c8857725e7">Move dataSource reset before connection returned</a></p> </blockquote> </div> </div> <hr> <div class="copyright text-center text-gray" role="contentinfo"> <i class="fa fa-copyright"></i> <span class="time">2016-2022,</span> <a class="text-gray" href="https://github.com/youzhanghao" rel="noreferrer" target="_blank">Reworld</a> Revision <a class="text-gray" href="https://github.com/youzhanghao/youzhanghao.github.io/commit/3e759db77de0ee3cdf2a53b3411433f3c7f9a7e9" title="3e759db77de0ee3cdf2a53b3411433f3c7f9a7e9" rel="noreferrer" target="_blank">3e759db</a> <br> <div class="generator"> Built with <a href="https://pages.github.com" rel="noreferrer" target="_blank" title="github-pages v209">GitHub Pages</a> using a <a href="https://github.com/rundocs/jekyll-rtd-theme" rel="noreferrer" target="_blank" title="jekyll-rtd-theme v2.0.10">theme</a> provided by <a href="https://rundocs.io" rel="noreferrer" target="_blank">RunDocs</a>. </div> </div> </div> </div> <div class="addons-wrap d-flex flex-column overflow-y-auto"> <div class="status d-flex flex-justify-between p-2"> <div class="title p-1"> <i class="fa fa-book"></i> Youzhanghao's Blog </div> <div class="branch p-1"> <span class="name"> gh-pages </span> <i class="fa fa-caret-down"></i> </div> </div> <div class="addons d-flex flex-column height-full p-2 d-none"> <dl> <dt>GitHub</dt> <dd> <a href="https://github.com/youzhanghao/youzhanghao.github.io" title="Stars: 0"> <i class="fa fa-github"></i> Homepage </a> </dd> <dd> <a href="https://github.com/youzhanghao/youzhanghao.github.io/issues" title="Open issues: 0"> <i class="fa fa-question-circle-o"></i> Issues </a> </dd> <dd> <a href="https://github.com/youzhanghao/youzhanghao.github.io/zipball/gh-pages" title="Size: 6952 Kb"> <i class="fa fa-download"></i> Download </a> </dd> </dl> <hr> <div class="license f6 pb-2"> This <a href="/" title="Youzhanghao's Blog">Software</a> is under the terms of <a href="https://github.com/youzhanghao/youzhanghao.github.io">MIT License</a>. </div> </div> </div> <script src="https://cdn.jsdelivr.net/gh/rundocs/jekyll-rtd-theme@2.0.10/assets/js/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/gh/rundocs/jekyll-rtd-theme@2.0.10/assets/js/theme.min.js"></script> </body> </html>